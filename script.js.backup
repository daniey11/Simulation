'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASE DATA â€” 3 Cases with branching decision trees
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CASES = [

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CASE 1: SHOCK
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'cc-1',
    title: 'Shock',
    blurb: 'Tele floor to ICU escalation. 67M admitted for CAP now diaphoretic, altered, and hypotensive on hospital day 2.',
    artType: 'shock',
    patient: { name: 'Gerald Hoffman', initials: 'GH', age: '67M', weight: '82 kg', allergies: 'NKDA' },

    vignette: `<p>A 67-year-old man with <span class="hl">T2DM, CKD stage 3, hypertension, COPD</span> was admitted for community-acquired pneumonia and started on ceftriaxone + azithromycin. He initially improved.</p><p>On <span class="hl">hospital day 2</span>, nursing calls the team for worsening confusion and hypotension. He is <span class="hl">diaphoretic, altered, and minimally responsive</span>. A rapid response is called.</p>`,

    rnReport: `"He was fine at 6am but I just went in and he barely responded when I called his name. His pressure is in the 80s. He's hot, flushed, and sweating through his gown. I've got a peripheral IV from admission. I sent a STAT call â€” what do you want me to do first?"`,
    rnCues: [
      'Look at the monitor. Note the vital signs.',
      'Verbalize your differential diagnosis for hypotension out loud.',
      'Think about what physical exam findings would change your management.'
    ],

    vitals: [
      { lbl: 'HR',   val: '118',    unit: 'bpm',        st: 'vw' },
      { lbl: 'BP',   val: '82/44',  unit: 'mm Hg',      st: 'vc' },
      { lbl: 'RR',   val: '28',     unit: '/min',        st: 'vw' },
      { lbl: 'SpOâ‚‚', val: '92%',   unit: '4L NC',       st: 'vw' },
      { lbl: 'Temp', val: '38.9Â°C', unit: 'oral',        st: 'vc' },
      { lbl: 'GCS',  val: '12',     unit: '/15',         st: 'vw' }
    ],

    labs: [
      { lbl: 'Lactate',  val: '4.5',      unit: 'mmol/L',  st: 'lv-c' },
      { lbl: 'WBC',      val: '19.6',     unit: 'K/ÂµL',    st: 'lv-c' },
      { lbl: 'Hgb',      val: '11.2',     unit: 'g/dL',    st: 'lv-a' },
      { lbl: 'Creat',    val: '2.1',      unit: '(bl 1.3)',st: 'lv-c' },
      { lbl: 'pH',       val: '7.31',     unit: 'ABG',     st: 'lv-c' },
      { lbl: 'PaCOâ‚‚',   val: '32',       unit: 'mm Hg',   st: 'lv-a' },
      { lbl: 'PaOâ‚‚',    val: '70',       unit: 'mm Hg',   st: 'lv-a' },
    ],
    labNote: 'EKG: Sinus tachycardia, no ischemic changes. CXR: Worsening RLL consolidation.',

    examSystems: [
      { icon:'ğŸ§ ', lbl:'Neuro',   key:'neuro',   text:'Confused, GCS 12. Oriented to person only. Responds to loud voice.' },
      { icon:'ğŸ‘ï¸', lbl:'General', key:'gen',     text:'Ill-appearing. Diaphoretic. Flushed and warm skin.' },
      { icon:'ğŸ‘„', lbl:'HEENT',   key:'heent',   text:'Dry mucous membranes. No JVD.' },
      { icon:'â¤ï¸', lbl:'Cardiac', key:'cardiac', text:'Tachycardic, regular rhythm. Warm extremities. Bounding pulses.' },
      { icon:'ğŸ«', lbl:'Lungs',   key:'lungs',   text:'Crackles right lower lobe. Tachypneic.' },
      { icon:'ğŸ«ƒ', lbl:'Abdomen', key:'abd',     text:'Soft, non-distended, mild RLQ tenderness.' },
      { icon:'ğŸ¦µ', lbl:'Extrem',  key:'ext',     text:'Warm, no edema. Cap refill 3 sec.' }
    ],

    pocus: {
      rows: [
        { k:'LV',     v:'Hyperdynamic systolic function â€” EF visually >70%' },
        { k:'RV',     v:'Normal size and function' },
        { k:'IVC',    v:'Small, collapsible (>50% collapse with sniff)' },
        { k:'Lungs',  v:'Focal B-lines right lower zone; A-lines elsewhere' },
        { k:'Pericard',v:'No effusion' }
      ],
      interp: 'Distributive shock with relative hypovolemia and preserved cardiac function. Hyperdynamic LV + collapsible IVC = septic/distributive physiology. NOT cardiogenic.'
    },

    // DECISION POINT 1 â€” initial resuscitation
    decision1: {
      title: 'Initial Resuscitation Decision',
      prompt: 'You have confirmed distributive shock. What is your initial management? Enter your orders below.',
      placeholder: `Order your initial resuscitation...
e.g.:
â€¢ IV fluids â€” type, volume, rate
â€¢ Blood cultures, urine culture
â€¢ Antibiotics â€” which agents?
â€¢ Vasopressor â€” which one? at what dose?
â€¢ Labs, lines, other interventions`,
      // Branching logic: evaluate keywords in order text
      branches: [
        {
          id: 'good-resus',
          label: 'âœ“ APPROPRIATE RESPONSE',
          type: 'good',
          // keywords that trigger this branch
          triggers: ['norepinephrine','norepi','norepinephrine','vasopressor','pressor','30 ml','30ml','fluids','culture','antibiotic','vancomycin','cefepime','pip','broad'],
          requires: 2, // need at least 2 trigger categories hit
          headline: 'Correct initial management',
          narrative: `You ordered fluid resuscitation, blood cultures, broad-spectrum antibiotics, and started norepinephrine. The ICU team is moving the patient.<br/><br/>
          After 30 mL/kg crystalloid: BP improves to <span class="hl">96/60 mm Hg</span> temporarily, but MAP remains 62. Norepinephrine is running at 0.08 mcg/kg/min. Repeat lactate at 2h: <span class="hl">3.2 mmol/L</span> â€” improving but still elevated.<br/><br/>
          The RN calls: <em>"He's transferred to the ICU. BP is responding slightly but he's still requiring pressors. He remains confused. What do you want to do next?"</em>`,
          nextDecision: 'decision2'
        },
        {
          id: 'fluid-only',
          label: 'âš  INCOMPLETE â€” FLUIDS WITHOUT PRESSORS',
          type: 'warning',
          triggers: ['fluid','saline','lactated','bolus','ns','lr'],
          requires: 1,
          excludes: ['norepi','norepinephrine','vasopressor','pressor'],
          headline: 'Fluids ordered but no vasopressor initiated',
          narrative: `You started IV fluids. After 1L NS, BP transiently rises to <span class="hl">88/52 mm Hg</span> then drops back to <span class="hl">78/44 mm Hg</span>. MAP remains critically low.<br/><br/>
          RN: <em>"Doctor, the pressure isn't holding. He's not responding to fluids alone. Should we start something for the blood pressure?"</em><br/><br/>
          You need to initiate a vasopressor â€” delay is increasing end-organ risk. Norepinephrine should be started now even via peripheral access.`,
          nextDecision: 'decision2-delayed'
        },
        {
          id: 'wrong-pressor',
          label: 'âš  INCORRECT VASOPRESSOR CHOICE',
          type: 'warning',
          triggers: ['dopamine','phenylephrine'],
          requires: 1,
          headline: 'Suboptimal vasopressor selected',
          narrative: `You selected an alternative vasopressor. In septic shock, <span class="hl">norepinephrine is first-line</span> (Surviving Sepsis Campaign â€” strong recommendation). Dopamine is associated with higher arrhythmia rates in this population (SOAP II trial). Phenylephrine is pure Î±â‚ â€” avoids tachycardia but may reduce CO in patients who need some Î²â‚ support.<br/><br/>
          The patient's BP partially responds. MAP is <span class="hl">60 mm Hg</span> â€” marginally adequate. The ICU attending asks you to reconsider your pressor choice.`,
          nextDecision: 'decision2'
        },
        {
          id: 'default',
          label: 'ORDERS RECEIVED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Orders documented',
          narrative: `Orders have been sent. Consider: Did you order blood cultures before antibiotics? Did you give IV fluids? Did you start a vasopressor to target MAP â‰¥65? Did you consider source control?`,
          nextDecision: 'decision2'
        }
      ]
    },

    // DECISION POINT 2 â€” escalation
    decision2: {
      title: 'Escalation â€” Persistent Shock',
      conditionAlert: true,
      alertText: 'Despite initial resuscitation, MAP remains <65 on norepinephrine 0.22 mcg/kg/min.',
      alertSub: 'ICU nurse: "He\'s on norepi, I\'ve given 3L total, but his pressure isn\'t maintaining. Repeat lactate is still 3.0."',
      vitals: [
        { lbl: 'HR',    val: '122',   unit: 'bpm',    st: 'vc' },
        { lbl: 'BP',    val: '79/42', unit: 'mm Hg',  st: 'vc' },
        { lbl: 'MAP',   val: '54',    unit: 'mm Hg',  st: 'vc' },
        { lbl: 'SpOâ‚‚',  val: '88%',  unit: '6L NC',  st: 'vc' },
        { lbl: 'UO',    val: '10 mL',unit: 'last hr', st: 'vc' },
        { lbl: 'GCS',   val: '10',   unit: '/15',     st: 'vc' }
      ],
      prompt: 'MAP remains <65 on norepinephrine alone. What is your next step?',
      placeholder: `Enter escalation plan...
e.g.:
â€¢ Second-line vasopressor â€” which one?
â€¢ Corticosteroids â€” when/why?
â€¢ Additional workup
â€¢ Airway considerations
â€¢ Invasive access`,
      branches: [
        {
          id: 'vasopressin',
          label: 'âœ“ CORRECT ESCALATION',
          type: 'good',
          triggers: ['vasopressin','hydrocortisone','steroid','central','arterial line','foley','urine output','intubate','airway'],
          requires: 2,
          headline: 'Appropriate escalation of shock management',
          narrative: `You added vasopressin and/or corticosteroids. Vasopressin (0.03 U/min) is added as per guidelines when norepi dose is â‰¥0.25 mcg/kg/min. Hydrocortisone 200 mg/day is reasonable for refractory septic shock.<br/><br/>
          Over the next hour, MAP improves to <span class="hl">68 mm Hg</span>. Norepinephrine is titrated down to 0.14 mcg/kg/min. SpOâ‚‚ worsens â€” the patient is now on NRB 15L with SpOâ‚‚ 88%.<br/><br/>
          RN: <em>"His pressure is better but he's really working to breathe. Are we going to intubate?"</em>`,
          nextDecision: null,
          endState: 'good',
          endMsg: 'Shock is being controlled. The patient stabilizes with multimodal vasopressor support and source control. He will require ICU-level monitoring, repeat cultures, de-escalation planning, and eventual extubation when ready.',
          decisions: ['Started norepinephrine first-line', 'Added vasopressin for refractory shock', 'Considered corticosteroids', 'Addressed airway']
        },
        {
          id: 'fluid-push',
          label: 'âš  EXCESSIVE FLUID RESUSCITATION',
          type: 'warning',
          triggers: ['more fluid','additional fluid','fluid bolus','another liter','2L','2000','bolus'],
          requires: 1,
          excludes: ['vasopressin','epinephrine'],
          headline: 'Continued fluid loading without vasopressor escalation',
          narrative: `You gave another 2L of crystalloid. Total fluid balance is now +5L. The patient's BP does not meaningfully improve. SpOâ‚‚ drops to <span class="hl">84%</span> on NRB â€” you hear new crackles bilaterally.<br/><br/>
          Pulmonary edema from fluid overload is complicating the picture. In septic shock, after the initial 30 mL/kg resuscitation, further fluids should be guided by dynamic fluid responsiveness markers â€” not given empirically. <span class="hl">Vasopressor escalation is required here.</span>`,
          nextDecision: null,
          endState: 'concern',
          endMsg: 'The patient developed iatrogenic pulmonary edema from excessive fluid loading. Vasopressor escalation (vasopressin Â± epinephrine) and careful fluid de-escalation are needed.',
          decisions: ['Appropriate antibiotics', 'Initial fluid resuscitation', 'Vasopressors NOT adequately escalated', 'Fluid overload contributed to respiratory failure']
        },
        {
          id: 'default2',
          label: 'ORDERS RECEIVED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Orders documented',
          narrative: `Consider: At norepi â‰¥0.25 mcg/kg/min, guidelines recommend adding vasopressin (VASST trial). Hydrocortisone 200 mg/day is appropriate for refractory septic shock. Limit further fluid boluses.`,
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Case complete. Key points: norepinephrine first-line, vasopressin as second-line, hydrocortisone for refractory shock, and avoid fluid overload.',
          decisions: ['Review vasopressor escalation algorithm', 'Consider corticosteroids in refractory shock']
        }
      ]
    },

    decision2Delayed: {
      title: 'Urgent Vasopressor Start â€” Delayed',
      conditionAlert: true,
      alertText: 'No vasopressor has been started. MAP is critically low. End-organ ischemia is developing.',
      alertSub: 'Fluids alone are insufficient for septic shock once MAP <65 despite resuscitation.',
      vitals: [
        { lbl: 'HR',   val: '132',   unit: 'bpm',    st: 'vc' },
        { lbl: 'BP',   val: '72/38', unit: 'mm Hg',  st: 'vc' },
        { lbl: 'MAP',  val: '49',    unit: 'mm Hg',  st: 'vc' },
        { lbl: 'SpOâ‚‚', val: '86%',   unit: '10L NRB',st: 'vc' },
        { lbl: 'GCS',  val: '9',     unit: '/15',    st: 'vc' }
      ],
      prompt: 'Start vasopressor support now. Which agent and at what dose?',
      placeholder: 'Enter vasopressor order now...',
      branches: [
        {
          id: 'late-norepi',
          label: 'VASOPRESSOR STARTED',
          type: 'warning',
          triggers: ['norepi','norepinephrine','vasopressor','pressor','dopamine','epinephrine'],
          requires: 1,
          headline: 'Vasopressor initiated â€” but delayed',
          narrative: `Norepinephrine is now running. MAP begins to recover toward 62 mm Hg over 20 minutes. However, the delay has resulted in worsening end-organ dysfunction â€” creatinine has risen and the GCS is lower.<br/><br/>
          <strong>Key learning:</strong> Norepinephrine should not wait for central access. Peripheral pressor via antecubital or larger peripheral IV with frequent site checks is safe for short-term bridging.`,
          nextDecision: 'decision2',
          endState: 'concern',
          endMsg: null,
          decisions: []
        },
        {
          id: 'default-delayed',
          label: 'ORDERS RECEIVED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Vasopressor needed urgently',
          narrative: 'Start norepinephrine immediately. Do not delay for line placement.',
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Vasopressor was not initiated promptly. In septic shock unresponsive to initial fluids, norepinephrine should be started early â€” including peripherally.',
          decisions: ['Vasopressor delay led to prolonged end-organ hypoperfusion']
        }
      ]
    }
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CASE 2: MASSIVE PE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'cc-2',
    title: 'Massive PE',
    blurb: 'Med-Surg RRT: 83F admitted for SBO suddenly confused and hypoxic. Cool extremities, elevated JVP, clear lungs â€” the hemodynamics don\'t fit pneumonia.',
    artType: 'pe',
    patient: { name: 'Ruth Nakamura', initials: 'RN', age: '83F', weight: '58 kg', allergies: 'PCN (Rash)' },

    vignette: `<p>An 83-year-old woman with <span class="hl">paraesophageal hernia, moderate aortic stenosis, remote colon cancer, early Alzheimer's</span> was admitted for a 2-day history of nausea/vomiting with CT findings of mild small bowel obstruction.</p><p>She was NPO Ã— 24h, improved, and was advanced to liquids. Surgery deferred: "medical management per primary." She was doing well until nursing calls an <span class="hl">RRT for acute AMS + hypoxia</span>. She has not been mobile since admission.</p>`,

    rnReport: `"She was totally fine at lunch, asking for her daughter. Now she's confused and her sat just dropped to 84% on 6 liters. Her pulse is 128. She doesn't have a fever. Lungs sound clear to me â€” I don't understand why she can't breathe. She hasn't been out of bed since she came in two days ago."`,
    rnCues: [
      'Note: clear lungs + hypoxia + tachycardia. What does this pattern suggest?',
      'Ask about VTE risk factors: immobility, prior cancer, post-op status.',
      'Do NOT give a large fluid bolus before you know the diagnosis.'
    ],

    vitals: [
      { lbl: 'HR',   val: '128',   unit: 'bpm, sinus', st: 'vc' },
      { lbl: 'BP',   val: '78/46', unit: 'mm Hg',      st: 'vc' },
      { lbl: 'RR',   val: '32',    unit: '/min',        st: 'vc' },
      { lbl: 'SpOâ‚‚', val: '84%',   unit: '6L NC',      st: 'vc' },
      { lbl: 'Temp', val: '36.8Â°C',unit: 'oral',        st: 'vn' },
      { lbl: 'JVP',  val: 'Elevated', unit: '~12 cm',  st: 'vc' }
    ],

    labs: [
      { lbl: 'pH',       val: '7.47',  unit: 'ABG',    st: 'lv-a' },
      { lbl: 'PaCOâ‚‚',   val: '30',    unit: 'mm Hg',  st: 'lv-a' },
      { lbl: 'PaOâ‚‚',    val: '52',    unit: 'mm Hg',  st: 'lv-c' },
      { lbl: 'Lactate',  val: '5.2',   unit: 'mmol/L', st: 'lv-c' },
      { lbl: 'Troponin', val: '53',    unit: 'mildlyâ†‘',st: 'lv-a' },
      { lbl: 'BNP',      val: '302',   unit: 'pg/mL',  st: 'lv-a' },
      { lbl: 'Creat',    val: '1.4',   unit: '(bl 1.0)',st:'lv-a' }
    ],
    labNote: 'EKG: Sinus tachycardia, new incomplete RBBB, T-wave inversions V1â€“V4. CXR: Clear lung fields, no consolidation, no PTX. LE Doppler (if ordered): Acute DVT right femoral vein.',

    examSystems: [
      { icon:'ğŸ˜°', lbl:'General', key:'gen',     text:'Ill-appearing. Anxious. Diaphoretic. Cyanotic lips. Speaking in short phrases.' },
      { icon:'ğŸ§ ', lbl:'Neuro',   key:'neuro',   text:'Confused, disoriented. GCS 13. Answering questions briefly. No focal deficits.' },
      { icon:'â¤ï¸', lbl:'Cardiac', key:'cardiac', text:'Tachycardic. Elevated JVP ~12 cm. Loud P2 component. Cool extremities.' },
      { icon:'ğŸ«', lbl:'Lungs',   key:'lungs',   text:'Clear bilaterally. No crackles, no wheeze. Tachypneic.' },
      { icon:'ğŸ«ƒ', lbl:'Abdomen', key:'abd',     text:'Soft. Mild distension consistent with SBO history. Non-tender.' },
      { icon:'ğŸ¦µ', lbl:'Extrem',  key:'ext',     text:'Cool. Right thigh appears slightly fuller/warmer than left. No pitting edema.' }
    ],

    pocus: {
      rows: [
        { k:'PSAX',    v:'RV dilation with septal flattening â€” D-sign present' },
        { k:'A4C',     v:'RV > LV (RV:LV ratio >1.0) â€” severe RV dilation' },
        { k:'IVC',     v:'Plethoric, >2.1 cm, <50% respiratory variation' },
        { k:'Lungs',   v:'A-lines bilaterally â€” no pulmonary edema' },
        { k:'Pericard',v:'No pericardial effusion' }
      ],
      interp: 'Obstructive shock from massive PE with acute RV failure. D-sign + RV > LV + plethoric IVC = classic acute cor pulmonale. Do NOT give large fluid boluses â€” this will worsen RV distension.'
    },

    decision1: {
      title: 'Initial Stabilization',
      prompt: 'POCUS confirms RV failure consistent with massive PE. The patient is hemodynamically unstable. What are your immediate orders?',
      placeholder: `Enter initial management orders...
e.g.:
â€¢ Oxygen delivery â€” escalate how?
â€¢ Vasopressor choice (consider RV physiology)
â€¢ Anticoagulation â€” start now or wait?
â€¢ Imaging â€” who can be safely transported?
â€¢ Who do you call?`,
      branches: [
        {
          id: 'pe-correct',
          label: 'âœ“ APPROPRIATE INITIAL MANAGEMENT',
          type: 'good',
          triggers: ['oxygen','nrb','norepinephrine','norepi','heparin','anticoagul','pert','ct','echo','pulmonary'],
          requires: 3,
          headline: 'Correct stabilization for massive PE',
          narrative: `You escalated oxygen to NRB, started norepinephrine, and initiated heparin. Good choices:<br/><br/>
          â€¢ <strong>Norepinephrine</strong> is preferred over dopamine/epinephrine in PE shock â€” it maintains SVR without excessive tachycardia that worsens RV ischemia.<br/>
          â€¢ <strong>Heparin</strong> started â€” prevents propagation while awaiting definitive therapy.<br/>
          â€¢ PERT activation called.<br/><br/>
          SpOâ‚‚ improves to <span class="hl">89%</span> on NRB 15L. BP is <span class="hl">78/44</span> on norepi 0.12 mcg/kg/min â€” still critically hypotensive. PERT team is calling you: <em>"We've reviewed the echo. This is massive PE. What's your plan for definitive therapy?"</em>`,
          nextDecision: 'decision2'
        },
        {
          id: 'pe-fluids',
          label: 'âš  LARGE FLUID BOLUS GIVEN',
          type: 'bad',
          triggers: ['2l','2 l','1l','1 l','fluid bolus','normal saline','lactated ringer','iv fluid','liter'],
          requires: 1,
          excludes: ['small','cautious','250','500 ml'],
          headline: 'Large fluid bolus â€” harmful in RV failure',
          narrative: `You gave a large fluid bolus. In massive PE with RV failure, aggressive fluid loading is <span class="hl">harmful</span>. The RV is already severely distended and pressure-overloaded.<br/><br/>
          After the bolus: HR â†’ 148, BP paradoxically drops to <span class="hl">66/38 mm Hg</span>. The patient becomes less responsive. POCUS shows worsening RV dilation with interventricular septal shift bowing into the LV.<br/><br/>
          <strong>Key learning:</strong> In obstructive shock from PE, fluids may worsen RV dilation â†’ impair LV filling â†’ reduce CO â†’ more hypotension. Limit to 250â€“500 mL if clearly preload-responsive.`,
          nextDecision: 'decision2'
        },
        {
          id: 'pe-default',
          label: 'ORDERS RECEIVED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Orders documented',
          narrative: 'Key priorities: escalate oxygen, start norepinephrine (not large fluids), begin heparin, call PERT, prepare for thrombolysis decision.',
          nextDecision: 'decision2'
        }
      ]
    },

    decision2: {
      title: 'Thrombolysis Decision',
      conditionAlert: true,
      alertText: 'Patient remains hemodynamically unstable on norepinephrine. MAP is 51 mm Hg.',
      alertSub: 'PERT team: "No absolute contraindications to tPA identified. Patient is on PCN allergy only â€” not a contraindication. She has no recent surgery, no ICH, no active bleeding. Do you want to proceed with systemic thrombolysis?"',
      vitals: [
        { lbl: 'HR',   val: '142',   unit: 'bpm',    st: 'vc' },
        { lbl: 'BP',   val: '74/40', unit: 'mm Hg',  st: 'vc' },
        { lbl: 'MAP',  val: '51',    unit: 'mm Hg',  st: 'vc' },
        { lbl: 'SpOâ‚‚', val: '87%',   unit: 'NRB 15L',st: 'vc' },
        { lbl: 'GCS',  val: '11',    unit: '/15',    st: 'vc' }
      ],
      prompt: 'The PERT team is asking for your decision on systemic thrombolysis. What do you order?',
      placeholder: `Enter your thrombolysis decision and supporting orders...
e.g.:
â€¢ Alteplase â€” dose? route? duration?
â€¢ What to do with heparin during tPA?
â€¢ Preparation / monitoring orders
â€¢ Contraindication check you perform
â€¢ Alternative if you decide against tPA`,
      branches: [
        {
          id: 'tpa-correct',
          label: 'âœ“ APPROPRIATE THROMBOLYSIS',
          type: 'good',
          triggers: ['tpa','alteplase','thrombolysis','thrombolytic','100 mg','100mg'],
          requires: 1,
          headline: 'Systemic thrombolysis initiated â€” correct decision',
          narrative: `Alteplase 100 mg IV over 2 hours via peripheral IV is administered. Heparin is <span class="hl">discontinued</span> during the infusion.<br/><br/>
          At 45 minutes into the tPA infusion:<br/>
          â€¢ BP rises to <span class="hl">104/68 mm Hg</span><br/>
          â€¢ SpOâ‚‚ improves to <span class="hl">94%</span> on NRB<br/>
          â€¢ HR decreases to <span class="hl">108 bpm</span><br/>
          â€¢ Patient opens eyes spontaneously and says "where am I?"<br/><br/>
          After infusion completes: heparin is resumed (no loading dose) once aPTT &lt; 2Ã— ULN. Patient is transferred to ICU for monitoring.`,
          nextDecision: null,
          endState: 'good',
          endMsg: 'Systemic thrombolysis resulted in hemodynamic improvement. The patient stabilizes and is transferred to the ICU for monitoring and anticoagulation management.',
          decisions: ['Correct identification of massive PE', 'Avoided large fluid bolus', 'Started norepinephrine appropriately', 'Administered tPA 100 mg IV over 2 hrs', 'Held heparin during tPA infusion', 'PERT team activated']
        },
        {
          id: 'tpa-refused',
          label: 'âš  THROMBOLYSIS WITHHELD',
          type: 'warning',
          triggers: ['no tpa','no thrombolysis','anticoagulation only','heparin only','conservative','ct first','scan first'],
          requires: 1,
          headline: 'Thrombolysis withheld â€” patient deteriorating',
          narrative: `You elected to continue anticoagulation without thrombolysis. Over the next 20 minutes, the patient's MAP drops to <span class="hl">42 mm Hg</span> despite maximum norepinephrine. She becomes unresponsive (GCS 7).<br/><br/>
          In <span class="hl">massive PE</span> (hemodynamically unstable with no absolute contraindications), systemic thrombolysis is the intervention most likely to reverse RV failure and restore cardiac output. Withholding it carries ~30â€“50% mortality risk.<br/><br/>
          PERT team: <em>"She's circling the drain. We need to give the tPA now or discuss surgical embolectomy."</em>`,
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Thrombolysis was appropriately indicated. Massive PE = hemodynamic instability without absolute contraindications â†’ systemic tPA is first-line. CT should not delay treatment in an unstable patient.',
          decisions: ['Diagnosis of massive PE made', 'Norepinephrine started', 'Thrombolysis not administered â€” patient deteriorated', 'Always weigh absolute vs relative contraindications']
        },
        {
          id: 'tpa-default',
          label: 'DECISION DOCUMENTED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Thrombolysis decision required',
          narrative: 'This is massive PE. Alteplase 100 mg IV over 2 hours is the standard regimen. Discontinue heparin during infusion. Resume without loading dose when aPTT <2Ã— ULN.',
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Case complete. Massive PE requires prompt thrombolysis decision. Alteplase 100 mg IV over 2 hrs is first-line.',
          decisions: ['Review massive PE thrombolysis criteria']
        }
      ]
    }
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CASE 3: ARDS / VENT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'cc-3',
    title: 'ARDS & Ventilator Management',
    blurb: 'ICU RRT for HFNC failure in a 54F with influenza A pneumonia. ROX index is dropping. You must decide when to intubate â€” then manage the vent.',
    artType: 'ards',
    patient: { name: 'Christine Vo', initials: 'CV', age: '54F', weight: '72 kg', allergies: 'NKDA' },

    vignette: `<p>A 54-year-old woman with <span class="hl">obesity and hypertension</span> presented with 5 days of fever, myalgias, cough, and progressive dyspnea. She tested positive for <span class="hl">influenza A</span> and was admitted for hypoxemia requiring HFNC.</p><p>Over the next several hours she has become increasingly tachypneic and hypoxic despite escalating support. Nursing calls an RRT for worsening respiratory distress. HFNC is currently at <span class="hl">60 L/min, FiOâ‚‚ 90%</span>.</p>`,

    rnReport: `"She keeps pulling at the cannula and she's using her neck muscles to breathe. She can only say two or three words at a time. Her sats were 92% at the last check and now the monitor is reading 84%. I calculated a ROX index and it came out 2.5 â€” I looked it up and that's bad, right? Her husband is here and he's terrified."`,
    rnCues: [
      'ROX index <3.85 predicts HFNC failure and need for intubation.',
      'Do not wait for desaturation to arrest â€” plan the airway now.',
      'Pre-oxygenation strategy and hemodynamic prep are essential before RSI.'
    ],

    vitals: [
      { lbl: 'HR',    val: '126',    unit: 'bpm',             st: 'vc' },
      { lbl: 'BP',    val: '108/64', unit: 'mm Hg',           st: 'vn' },
      { lbl: 'RR',    val: '38',     unit: '/min',            st: 'vc' },
      { lbl: 'SpOâ‚‚',  val: '84%',   unit: 'HFNC 60L FiOâ‚‚90%',st: 'vc' },
      { lbl: 'Temp',  val: '38.2Â°C', unit: 'oral',            st: 'vw' },
      { lbl: 'ROX',   val: '2.5',    unit: 'index',           st: 'vc' }
    ],

    labs: [
      { lbl: 'pH',      val: '7.48',  unit: 'ABG',    st: 'lv-a' },
      { lbl: 'PaCOâ‚‚',  val: '30',    unit: 'mm Hg',  st: 'lv-a' },
      { lbl: 'PaOâ‚‚',   val: '52',    unit: 'mm Hg',  st: 'lv-c' },
      { lbl: 'P/F',     val: '~58',   unit: 'mm Hg',  st: 'lv-c' },
      { lbl: 'Lactate', val: '2.6',   unit: 'mmol/L', st: 'lv-a' },
      { lbl: 'WBC',     val: '14',    unit: 'K/ÂµL',   st: 'lv-a' },
      { lbl: 'BMP',     val: 'Normal',unit: '',       st: 'lv-n' }
    ],
    labNote: 'EKG: Sinus tachycardia only. CXR: Bilateral diffuse patchy opacities â€” no PTX. P/F ~58 = Severe ARDS by Berlin criteria (P/F <100).',

    examSystems: [
      { icon:'ğŸ˜°', lbl:'General', key:'gen',     text:'Severe respiratory distress. Tripod positioning. Accessory muscle use. Diaphoretic. 3-word sentences.' },
      { icon:'ğŸ§ ', lbl:'Neuro',   key:'neuro',   text:'Anxious but alert. GCS 14. Oriented Ã—4. Following commands. Tiring.' },
      { icon:'ğŸ«', lbl:'Lungs',   key:'lungs',   text:'Diffuse bilateral crackles. Decreased air entry bases bilaterally. No wheeze.' },
      { icon:'â¤ï¸', lbl:'Cardiac', key:'cardiac', text:'Tachycardic. Regular. No murmurs. No elevated JVP (not cardiogenic).' },
      { icon:'ğŸ«ƒ', lbl:'Abdomen', key:'abd',     text:'Soft, mildly distended (aerophagia from HFNC). Non-tender.' },
      { icon:'ğŸ¦µ', lbl:'Extrem',  key:'ext',     text:'Warm. No edema. Good peripheral pulses.' }
    ],

    pocus: {
      rows: [
        { k:'LV',      v:'Normal systolic function â€” EF visually preserved, not cardiogenic' },
        { k:'RV',      v:'Normal size, no dilation' },
        { k:'Lungs',   v:'Diffuse bilateral B-lines â€” alveolar flooding pattern' },
        { k:'Effusion',v:'No pleural effusions bilaterally' },
        { k:'Pericard',v:'No pericardial effusion' }
      ],
      interp: 'Non-cardiogenic pulmonary edema consistent with ARDS. Normal LV function excludes cardiogenic cause. Diffuse B-lines = severe alveolar flooding. Berlin criteria: Severe ARDS (P/F 58, PEEP â‰¥5).'
    },

    decision1: {
      title: 'Intubation Decision',
      prompt: 'ROX index 2.5, SpOâ‚‚ 84% on max HFNC, patient tiring. What is your plan?',
      placeholder: `Enter your airway and intubation plan...
e.g.:
â€¢ Proceed with intubation â€” what pre-oxygenation?
â€¢ RSI agents â€” what drugs and doses?
â€¢ Hemodynamic prep â€” what are you concerned about?
â€¢ Initial vent settings post-intubation
â€¢ What tidal volume will you target?`,
      branches: [
        {
          id: 'intubate-correct',
          label: 'âœ“ INTUBATION PLAN WITH LPV',
          type: 'good',
          triggers: ['intubate','intubation','rsi','ketamine','succinylcholine','rocuronium','6 ml','6ml','lung protective','pbw','predicted','ardsnet','peep'],
          requires: 2,
          headline: 'Appropriate intubation plan with lung-protective ventilation',
          narrative: `You proceed with intubation. Pre-oxygenation with HFNC flush + NRB applied. RSI performed successfully.<br/><br/>
          Respiratory therapy asks: <em>"What vent settings do you want?"</em><br/><br/>
          <strong>Calculate predicted body weight (PBW):</strong><br/>
          For a 5'4" female: PBW = 45.5 + 2.3 Ã— (64 âˆ’ 60) = <span class="hl">54.7 kg</span><br/>
          Target VT = 6 mL/kg Ã— 54.7 = <span class="hl">328 mL</span> (NOT 6 Ã— 72 kg actual weight)<br/><br/>
          Initial settings: VT 330 mL, FiOâ‚‚ 1.0, PEEP 10, RR 20. RT reports plateau pressure: <span class="hl">28 cm Hâ‚‚O</span>. SpOâ‚‚ 90%.`,
          nextDecision: 'decision2'
        },
        {
          id: 'wrong-vt',
          label: 'âš  INTUBATED â€” WRONG TIDAL VOLUME',
          type: 'warning',
          triggers: ['intubate','rsi','vent','ventilat'],
          requires: 1,
          excludes: ['6 ml','6ml','pbw','predicted','329','330','328','327','326','325'],
          headline: 'Intubated but volutrauma risk',
          narrative: `Patient intubated. RT asks for vent settings. You ordered VT 430 mL (based on 6 mL/kg of actual weight 72 kg).<br/><br/>
          <strong>Common error:</strong> Tidal volume must be based on <span class="hl">Predicted Body Weight (PBW)</span>, not actual weight.<br/><br/>
          PBW for 5'4" female = 45.5 + 2.3 Ã— (64 âˆ’ 60) = <span class="hl">54.7 kg</span><br/>
          Correct VT = 6 Ã— 54.7 = <span class="hl">328 mL</span><br/><br/>
          With your 430 mL VT, plateau pressure is <span class="hl">34 cm Hâ‚‚O</span> â€” exceeds the â‰¤30 limit. RT flags this. You need to reduce VT now.`,
          nextDecision: 'decision2'
        },
        {
          id: 'delay-intubation',
          label: 'âš  BIPAP/CPAP TRIAL INSTEAD',
          type: 'warning',
          triggers: ['bipap','cpap','non-invasive','niv','mask ventilation','continue hfnc'],
          requires: 1,
          headline: 'Non-invasive ventilation attempted â€” HFNC already failing',
          narrative: `You trial BiPAP. Initial synchrony is poor due to high respiratory drive. SpOâ‚‚ briefly improves to 89% but drops again to <span class="hl">81%</span> within 20 minutes. Patient is now unable to protect airway.<br/><br/>
          An emergent intubation under worse physiologic conditions is harder â€” lower pre-intubation SpOâ‚‚, fatigued patient, agitated.<br/><br/>
          <strong>Key learning:</strong> When HFNC is failing (ROX <3.85, SpOâ‚‚ <88% on max HFNC), intubation should be performed semi-electively, not as an emergency. Non-invasive rescue is reasonable if not yet at failure threshold.`,
          nextDecision: 'decision2'
        },
        {
          id: 'intubate-default',
          label: 'ORDERS DOCUMENTED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Proceed to intubation',
          narrative: 'Intubation needed. RSI: ketamine 1.5 mg/kg + succinylcholine 1.5 mg/kg (or rocuronium 1.2 mg/kg). Post-intubation: VT 6 mL/kg PBW.',
          nextDecision: 'decision2'
        }
      ]
    },

    decision2: {
      title: 'Post-Intubation Vent Management',
      conditionAlert: true,
      alertText: 'Post-intubation: SpOâ‚‚ 88%, FiOâ‚‚ 1.0, PEEP 10, RR 20. Plateau pressure is 36 cm Hâ‚‚O.',
      alertSub: 'RT: "Plateau pressure is over 30. What do you want to do with the vent?" Current VT is set at 430 mL.',
      vitals: [
        { lbl: 'SpOâ‚‚',  val: '88%',    unit: 'FiOâ‚‚ 1.0',   st: 'vc' },
        { lbl: 'Pplat',  val: '36',     unit: 'cm Hâ‚‚O',     st: 'vc' },
        { lbl: 'VT set', val: '430 mL', unit: '(actual wt)', st: 'vw' },
        { lbl: 'PEEP',   val: '10',     unit: 'cm Hâ‚‚O',     st: 'vn' },
        { lbl: 'RR',     val: '20',     unit: 'set',         st: 'vn' },
        { lbl: 'BP',     val: '88/52',  unit: 'mm Hg',      st: 'vc' }
      ],
      prompt: 'Plateau pressure is 36 cm Hâ‚‚O â€” above the 30 limit. How do you adjust the ventilator?',
      placeholder: `Enter vent adjustments...
e.g.:
â€¢ Correct VT to __ mL (show your PBW calculation)
â€¢ Adjust PEEP using ARDSnet table â€” target oxygenation
â€¢ pH / COâ‚‚ management approach
â€¢ Sedation / analgesia orders
â€¢ When would you prone this patient?`,
      branches: [
        {
          id: 'vent-correct',
          label: 'âœ“ CORRECT VENT ADJUSTMENT',
          type: 'good',
          triggers: ['328','329','330','327','326','325','pbw','reduce vt','decrease vt','6 ml','lower vt','lung protective'],
          requires: 1,
          headline: 'Correct tidal volume reduction â€” lung-protective ventilation',
          narrative: `You recalculate PBW and reduce VT to <span class="hl">328 mL (6 mL/kg PBW)</span>. Plateau pressure drops to <span class="hl">26 cm Hâ‚‚O</span>.<br/><br/>
          You increase PEEP to 14 per the ARDSnet higher PEEP/lower FiOâ‚‚ table. SpOâ‚‚ improves to <span class="hl">93%</span>. FiOâ‚‚ titrated down to 0.7.<br/><br/>
          P/F ratio: <span class="hl">52/0.7 = ~74</span> â€” still severe ARDS. RT asks: "At this P/F ratio, would you consider proning?"<br/><br/>
          <strong>Prone positioning:</strong> PROSEVA guidelines recommend prone â‰¥16 hrs/day when P/F &lt;150 despite optimized conventional ventilation. This patient qualifies.`,
          nextDecision: null,
          endState: 'good',
          endMsg: 'Lung-protective ventilation achieved. Low VT, plateau pressure â‰¤30, higher PEEP strategy. With persistent severe ARDS (P/F <150), prone positioning should be initiated per PROSEVA protocol.',
          decisions: ['Identified HFNC failure and intubated appropriately', 'Calculated PBW correctly', 'Achieved Pplat â‰¤30 cm Hâ‚‚O', 'Used ARDSnet FiOâ‚‚/PEEP table', 'Recognized proning indication (P/F <150)']
        },
        {
          id: 'vent-increase-rr',
          label: 'âš  INCREASED RR INSTEAD OF REDUCING VT',
          type: 'warning',
          triggers: ['increase rr','raise rr','rr 28','rr 30','rr 32','rr 25','more breaths','faster rate'],
          requires: 1,
          excludes: ['reduce vt','decrease vt','pbw','lower vt'],
          headline: 'Addressed COâ‚‚ but not volutrauma',
          narrative: `You increased the respiratory rate. COâ‚‚ will decrease but the <span class="hl">plateau pressure problem is not addressed</span> â€” you haven't reduced the tidal volume.<br/><br/>
          Pplat remains <span class="hl">36 cm Hâ‚‚O</span>. Every breath continues to overstretch the injured alveoli (volutrauma + barotrauma).<br/><br/>
          <strong>Key distinction:</strong> RR controls COâ‚‚ (ventilation). VT controls Pplat and volutrauma risk. For high Pplat, <span class="hl">reduce VT first</span> â€” accept permissive hypercapnia (pH â‰¥7.20) rather than maintaining high Pplat.`,
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Volutrauma risk persisted. Tidal volume must be reduced to 6 mL/kg PBW. Permissive hypercapnia (target pH 7.20â€“7.45) is acceptable to achieve this.',
          decisions: ['Intubated appropriately', 'Did not address elevated Pplat â€” VT reduction required', 'Increased RR alone does not resolve barotrauma risk']
        },
        {
          id: 'vent-default',
          label: 'ORDERS DOCUMENTED',
          type: 'neutral',
          triggers: [],
          requires: 0,
          headline: 'Vent adjustment needed',
          narrative: 'Reduce VT to 6 mL/kg PBW. PBW (female 5\'4") = 54.7 kg â†’ VT = 328 mL. Target Pplat â‰¤30 cm Hâ‚‚O.',
          nextDecision: null,
          endState: 'concern',
          endMsg: 'Always calculate PBW before setting tidal volume in ARDS. Lung-protective ventilation requires VT 6 mL/kg PBW, not actual weight.',
          decisions: ['Review ARDSnet lung-protective ventilation protocol']
        }
      ]
    }
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASE ART SVGs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ARTS = {
  shock: {
    bg: 'background:radial-gradient(ellipse at 50% 50%,rgba(233,165,53,0.18) 0%,transparent 70%),linear-gradient(155deg,#0c1829 0%,#14120a 100%)',
    svg: `<svg viewBox="0 0 80 80" fill="none"><path d="M40 62C40 62 16 46 16 30C16 22 22 16 30 16C34 16 38 18 40 22C42 18 46 16 50 16C58 16 64 22 64 30C64 46 40 62 40 62Z" stroke="#e9a535" stroke-width="1.5" fill="rgba(233,165,53,0.1)"/><path d="M14 40L24 40L28 32L32 48L36 36L40 40L66 40" stroke="#e9a535" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
  },
  pe: {
    bg: 'background:radial-gradient(ellipse at 50% 50%,rgba(224,79,79,0.18) 0%,transparent 70%),linear-gradient(155deg,#0c1829 0%,#150b0b 100%)',
    svg: `<svg viewBox="0 0 80 80" fill="none"><ellipse cx="28" cy="46" rx="14" ry="20" stroke="#e04f4f" stroke-width="1.5" opacity=".7"/><ellipse cx="52" cy="46" rx="14" ry="20" stroke="#e04f4f" stroke-width="1.5" opacity=".7"/><path d="M40 16L40 42" stroke="#e04f4f" stroke-width="2" stroke-linecap="round"/><path d="M40 23C34 23 28 29 28 37" stroke="#e04f4f" stroke-width="1.5" fill="none"/><path d="M40 23C46 23 52 29 52 37" stroke="#e04f4f" stroke-width="1.5" fill="none"/><circle cx="52" cy="30" r="8" stroke="#e9a535" stroke-width="1.5" fill="rgba(233,165,53,0.15)"/><line x1="52" y1="26" x2="52" y2="34" stroke="#e9a535" stroke-width="1.5"/><line x1="48" y1="30" x2="56" y2="30" stroke="#e9a535" stroke-width="1.5"/></svg>`
  },
  ards: {
    bg: 'background:radial-gradient(ellipse at 50% 50%,rgba(63,157,224,0.18) 0%,transparent 70%),linear-gradient(155deg,#0c1829 0%,#0b1520 100%)',
    svg: `<svg viewBox="0 0 80 80" fill="none"><ellipse cx="27" cy="46" rx="14" ry="20" stroke="#3f9de0" stroke-width="1.5" fill="rgba(63,157,224,0.07)"/><ellipse cx="53" cy="46" rx="14" ry="20" stroke="#3f9de0" stroke-width="1.5" fill="rgba(63,157,224,0.07)"/><path d="M40 15L40 42" stroke="#3f9de0" stroke-width="2" stroke-linecap="round"/><path d="M40 23C34 23 27 29 27 38" stroke="#3f9de0" stroke-width="1.5"/><path d="M40 23C46 23 53 29 53 38" stroke="#3f9de0" stroke-width="1.5"/><path d="M18 50Q22 46 26 50Q30 54 34 50" stroke="#e04f4f" stroke-width="1.2" fill="none"/><path d="M46 50Q50 46 54 50Q58 54 62 50" stroke="#e04f4f" stroke-width="1.2" fill="none"/></svg>`
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const State = {
  caseData: null,
  revealed: new Set(),
  decisions: [],        // track what branch outcomes the user hit
  currentDecision: null,// 'decision1' | 'decision2' | 'decision2Delayed'

  reset() {
    this.caseData = null;
    this.revealed = new Set();
    this.decisions = [];
    this.currentDecision = null;
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $ = id => document.getElementById(id);
const CE = tag => document.createElement(tag);

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const t = $(id);
  if (t) { t.classList.add('active'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
}

function openModal(id) {
  const el = $(id); if (!el) return;
  el.removeAttribute('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  const el = $(id); if (!el) return;
  el.setAttribute('hidden', '');
  document.body.style.overflow = '';
}

function closeAllModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.setAttribute('hidden', ''));
  document.body.style.overflow = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildPhaseTrack(totalPhases, activePhase) {
  const track = $('phase-track');
  if (!track) return;
  let html = '';
  for (let i = 1; i <= totalPhases; i++) {
    const cls = i < activePhase ? 'done' : i === activePhase ? 'active' : '';
    html += `<div class="ph-dot ${cls}">${i}</div>`;
    if (i < totalPhases) html += `<div class="ph-line"></div>`;
  }
  track.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASE SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCaseList() {
  const grid = $('cases-grid');
  if (!grid) return;
  grid.innerHTML = CASES.map((c, i) => {
    const art = ARTS[c.artType];
    return `
      <div class="case-card" data-idx="${i}" tabindex="0" role="button" aria-label="Launch ${c.title}">
        <div class="case-card-art" style="${art.bg}">${art.svg}</div>
        <div class="case-card-body">
          <div class="case-num">Case 0${i + 1}</div>
          <div class="case-title-text">${c.title}</div>
          <div class="case-blurb">${c.blurb}</div>
          <span class="case-tag">Advanced</span>
        </div>
      </div>
    `;
  }).join('');

  grid.querySelectorAll('.case-card').forEach(card => {
    const go = () => launchCase(parseInt(card.dataset.idx));
    card.addEventListener('click', go);
    card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); go(); } });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH A CASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function launchCase(idx) {
  State.reset();
  State.caseData = CASES[idx];
  $('sim-case-label').textContent = `${State.caseData.title}`;
  showScreen('screen-sim');
  buildPhaseTrack(5, 1);
  renderPhase1_Vignette();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function patientStrip() {
  const c = State.caseData;
  return `
    <div class="pt-strip">
      <div class="pt-avatar">${c.patient.initials}</div>
      <div><div class="pt-name">${c.patient.name}</div><div class="pt-meta">${c.patient.age} Â· Simulation</div></div>
      <div class="pt-chips">
        <div><div class="pt-chip-label">Weight</div><div class="pt-chip-val">${c.patient.weight}</div></div>
        <div><div class="pt-chip-label">Allergies</div><div class="pt-chip-val">${c.patient.allergies}</div></div>
      </div>
    </div>
  `;
}

function vitalsTable(vitals) {
  return `
    <table class="vitals-tbl">
      <thead><tr><th>Parameter</th><th>Value</th><th>Notes</th></tr></thead>
      <tbody>
        ${vitals.map(v => `<tr><td>${v.lbl}</td><td class="${v.st}">${v.val}</td><td>${v.unit}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
}

function labGrid(labs, note) {
  return `
    <div class="lab-grid">${labs.map(l => `<div class="lab-cell"><div class="lab-lbl">${l.lbl}</div><div class="lab-val ${l.st}">${l.val}${l.unit ? ' <span style="font-size:10px;color:var(--tx-3)">' + l.unit + '</span>' : ''}</div></div>`).join('')}</div>
    ${note ? `<div style="font-family:var(--font-m);font-size:10px;color:var(--tx-3);line-height:1.6;margin-top:8px;">${note}</div>` : ''}
  `;
}

function examGrid(systems) {
  return `
    <div class="exam-grid" id="exam-grid">
      ${systems.map(s => `
        <button class="exam-btn" data-key="${s.key}" aria-label="Examine ${s.lbl}">
          <div class="eb-icon">${s.icon}</div>
          <div class="eb-label">${s.lbl}</div>
          <div class="eb-hint">Tap to examine</div>
        </button>
      `).join('')}
    </div>
    <div class="exam-reveals" id="exam-reveals"></div>
  `;
}

function pocusBlock(pocus) {
  return `
    <div class="pocus-wrap">
      <div class="pocus-head"><span class="pocus-lbl">POCUS â€” Bedside Ultrasound Findings</span></div>
      <div class="pocus-body">
        <div class="pocus-rows">${pocus.rows.map(r => `<div class="pocus-row"><div class="pocus-k">${r.k}</div><div class="pocus-v">${r.v}</div></div>`).join('')}</div>
        <div class="pocus-interp"><div class="pocus-interp-lbl">Interpretation</div><div class="pocus-interp-txt">${pocus.interp}</div></div>
      </div>
    </div>
  `;
}

function bindExamButtons() {
  const grid = $('exam-grid');
  if (!grid) return;
  grid.querySelectorAll('.exam-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      if (State.revealed.has(key)) return;
      State.revealed.add(key);
      btn.classList.add('revealed');
      btn.querySelector('.eb-hint').textContent = 'Examined âœ“';
      const sys = State.caseData.examSystems.find(s => s.key === key);
      if (!sys) return;
      const card = CE('div');
      card.className = 'reveal-card';
      card.innerHTML = `<div class="reveal-sys">${sys.icon} ${sys.lbl}</div><div class="reveal-txt">${sys.text}</div>`;
      $('exam-reveals').appendChild(card);
    });
  });
}

function ordersSection(decisionKey) {
  const dec = State.caseData[decisionKey];
  return `
    <div class="sec-lbl">Order Entry</div>
    <div class="order-panel">
      <div class="order-input-wrap">
        <textarea class="orders-ta" id="orders-ta"
          placeholder="Type each order on a new line&#10;e.g.: Lactate&#10;CBC, BMP&#10;Blood cultures x2&#10;500 mL LR bolus IV&#10;Norepinephrine 0.05 mcg/kg/min IV&#10;Portable CXR&#10;EKG"></textarea>
      </div>
      <div class="order-parse-preview" id="order-preview">
        <div class="opp-header">
          <span class="opp-title">Order Recognition</span>
          <span class="opp-count" id="opp-count">0 orders</span>
        </div>
        <div class="opp-empty" id="opp-empty">Start typing orders above â€” each line will be parsed and categorized in real time.</div>
        <div class="opp-lines" id="opp-lines" style="display:none;"></div>
      </div>
      <div id="result-feed-wrap" style="display:none;">
        <div class="result-feed">
          <div class="result-feed-header">Results &amp; Acknowledgements</div>
          <div id="result-feed-cards"></div>
        </div>
      </div>
      <div class="orders-hint">Each order is recognized and categorized. Results appear in real time after you submit. Specific orders unlock specific results â€” order what you need.</div>
      <div class="btn-row">
        <button class="btn btn--primary" id="submit-orders" data-dec="${decisionKey}">Submit All Orders â†’</button>
      </div>
    </div>
  `;
}

function conditionAlertBlock(dec) {
  if (!dec.conditionAlert) return '';
  return `
    <div class="cond-alert">
      <div class="cond-icon">âš </div>
      <div>
        <div class="cond-title">${dec.alertText}</div>
        <div class="cond-sub">${dec.alertSub}</div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORDER INTELLIGENCE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CATEGORY CLASSIFIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each rule: { cat, label, patterns[] }  patterns are regex-like strings matched against lowercase line
const ORDER_CATEGORIES = {
  lab: {
    label: 'Lab',
    cssClass: 'cat-lab',
    typeClass: 'rct-lab',
    patterns: [
      /\bcbc\b/, /\bcomplete blood count\b/,
      /\bbmp\b/, /\bcmp\b/, /\bbasic metabolic\b/, /\bcomprehensive metabolic\b/,
      /\blactate\b/, /\blactic acid\b/,
      /\btroponin\b/, /\bhstrop\b/,
      /\bbnp\b/, /\bnt.pro.?bnp\b/,
      /\blft\b/, /\bliver function\b/,
      /\bcoag\b/, /\bpt\b(?![\w])/, /\bptt\b/, /\binr\b/, /\bprotime\b/,
      /\bblood culture\b/, /\bbc\b(?![\w])/, /\bculture\b/,
      /\burine culture\b/, /\bua\b(?![\w])/, /\burinalysis\b/,
      /\babg\b/, /\barterial blood gas\b/,
      /\bvbg\b/, /\bvenous blood gas\b/,
      /\bd.?dimer\b/,
      /\bprocalcitonin\b/, /\bpct\b(?![\w])/,
      /\bcreatinine\b/, /\bcreat\b/, /\bbun\b/,
      /\bglucose\b/,
      /\bhemoglobin\b/, /\bhgb\b/, /\bhematocrit\b/, /\bhct\b/,
      /\bplatelet\b/, /\bplts?\b/,
      /\bwbc\b/, /\bwhite blood cell\b/,
      /\btype and screen\b/, /\btype and cross\b/, /\bt&s\b/, /\bt&c\b/,
      /\bamylase\b/, /\blipase\b/,
      /\bph\b(?!ysical|armac)/, /\bpaco2\b/, /\bpao2\b/,
      /\brepeat lactate\b/, /\bfollow.?up lactate\b/,
      /\bpockit?\b/, /\bpoint.of.care\b/,
    ]
  },
  imaging: {
    label: 'Imaging',
    cssClass: 'cat-imaging',
    typeClass: 'rct-imaging',
    patterns: [
      /\bcxr\b/, /\bchest.?x.?ray\b/, /\bchest radiograph\b/,
      /\bct\b(?![\w])/, /\bcomputed tom/,
      /\bct.?chest\b/, /\bct.?abdomen\b/, /\bct.?pelvis\b/, /\bct.?ap\b/, /\bct.?head\b/,
      /\bctpa\b/, /\bct.?pulmonary\b/, /\bct.?angio\b/,
      /\bxr\b(?![\w])/, /\bx.?ray\b/,
      /\bkub\b/,
      /\bmri\b/,
      /\bdoppler\b/,
      /\bultrasound\b/, /\bus\b(?!e)(?![a-z])/, /\bechocardiograph\b/, /\becho\b(?![\w])/,
      /\bpocus\b/, /\bbedside echo\b/, /\bbedside ultrasound\b/,
      /\bv\/q\b/, /\bventilation.?perfusion\b/,
    ]
  },
  ekg: {
    label: 'EKG',
    cssClass: 'cat-ekg',
    typeClass: 'rct-ekg',
    patterns: [
      /\bekg\b/, /\becg\b/, /\belectrocardiog\b/, /\b12.?lead\b/, /\bcardiac monitor\b/
    ]
  },
  fluid: {
    label: 'IV Fluid',
    cssClass: 'cat-fluid',
    typeClass: 'rct-fluid',
    patterns: [
      /\blactated ringer\b/, /\blr\b(?![\w])/, /\blrs\b(?![\w])/,
      /\bnormal saline\b/, /\bns\b(?![\w])/, /\b0\.9.*saline\b/, /\b0\.9%\b/,
      /\bhalf.?normal\b/, /\b0\.45.*saline\b/, /\bd5\b/,
      /\biv fluid\b/, /\biv.?fluid\b/,
      /\bbolus\b/, /\bfluid bolus\b/,
      /\b\d+\s?ml\b/, /\b\d+\s?cc\b/, /\b\d+\s?liter\b/, /\b\d+l\s?(?:ns|lr|saline)\b/,
      /\bcrystalloid\b/, /\bcolloid\b/, /\bplasmalyte\b/,
      /\bfree water\b/, /\bmaintenance fluid\b/, /\bmaintenance rate\b/,
      /\bblood product\b/, /\bprbc\b/, /\bpacked red\b/, /\bffp\b/, /\bcryoprecipitate\b/, /\bplatelets?\b(?! count)/,
    ]
  },
  med: {
    label: 'Medication',
    cssClass: 'cat-med',
    typeClass: 'rct-med',
    patterns: [
      // vasopressors
      /\bnorepinephrine\b/, /\bnorepi\b/,
      /\bvasopressin\b/, /\bvaso\b(?!pressor)/,
      /\bepinephrine\b/, /\bepi\b(?![\w])/,
      /\bdopamine\b/,
      /\bphenylephrine\b/,
      /\bdobutamine\b/, /\bmilrinone\b/,
      // antibiotics
      /\bvancomycin\b/, /\bvanco\b/,
      /\bcefepime\b/, /\bceftriaxone\b/, /\bcefazolin\b/, /\bceftazidime\b/,
      /\bpiperacillin\b/, /\bzosyn\b/, /\bpip.?tazo\b/,
      /\bmeropenem\b/, /\bimipenem\b/, /\beropenem\b/,
      /\bazithromycin\b/, /\bdoxycycline\b/,
      /\bmetronidazole\b/, /\bflagyl\b/,
      /\bfluconazole\b/,
      /\bantibiotic\b/, /\bbroadspectrum\b/, /\bbroad spectrum\b/,
      // anticoagulants
      /\bheparin\b/,
      /\benoxaparin\b/, /\blovenox\b/, /\blmwh\b/,
      /\brivaroxaban\b/, /\bapixaban\b/, /\bdabigatran\b/,
      /\bwarfarin\b/, /\bcoumadin\b/,
      // thrombolytics
      /\btpa\b/, /\balteplase\b/, /\btenecteplase\b/, /\bthrombolysis\b/, /\bthrombolytic\b/,
      // sedation / RSI
      /\bketamine\b/,
      /\bpropofol\b/, /\bdiprivan\b/,
      /\bmidazolam\b/, /\bversed\b/,
      /\bfentanyl\b/, /\bmorphine\b/, /\bhydromorphone\b/,
      /\bsuccinylcholine\b/, /\brocuronium\b/, /\bvecuronium\b/, /\bcisatracurium\b/,
      /\bnmba\b/, /\bneuromuscular\b/,
      /\brsi\b/, /\brapid sequence\b/,
      // steroids
      /\bhydrocortisone\b/, /\bdexamethasone\b/, /\bmethylprednisolone\b/,
      // antihypertensives
      /\blabetalol\b/, /\bnicardipine\b/, /\bnitroprusside\b/, /\bnitroglycerin\b/,
      // other
      /\bzofran\b/, /\bondansetron\b/,
      /\bppi\b/, /\bpantoprazole\b/, /\bomeprazole\b/,
      /\binsulin\b/,
      /\bacetaminophen\b/, /\btylenol\b/,
      /\bibuprofen\b/,
      /\boseltamivir\b/, /\btamiflu\b/,
    ]
  }
};

function classifyOrderLine(line) {
  const l = line.toLowerCase().trim();
  if (!l || l.startsWith('//') || l.startsWith('#')) return null;
  for (const [cat, def] of Object.entries(ORDER_CATEGORIES)) {
    if (def.patterns.some(p => p.test(l))) {
      return { cat, label: def.label, cssClass: def.cssClass };
    }
  }
  // Heuristic: if line contains "order", "give", "start", "administer", "mg", "mcg", "unit" â†’ probably med
  if (/\b(order|give|administer|start|mg|mcg|units?|iv |po |sq |im )\b/.test(l)) {
    return { cat: 'med', label: 'Medication', cssClass: 'cat-med' };
  }
  return { cat: 'other', label: 'Other', cssClass: 'cat-other' };
}

// â”€â”€ LIVE PARSE PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindOrderPreview() {
  const ta = $('orders-ta');
  if (!ta) return;
  ta.addEventListener('input', () => {
    const lines = ta.value.split('\n').filter(l => l.trim().length > 1);
    const count = $('opp-count');
    const empty = $('opp-empty');
    const linesDiv = $('opp-lines');
    if (!count || !empty || !linesDiv) return;

    const parsed = lines.map(l => ({ raw: l.trim(), cls: classifyOrderLine(l) })).filter(x => x.cls);
    count.textContent = `${parsed.length} order${parsed.length !== 1 ? 's' : ''}`;

    if (parsed.length === 0) {
      empty.style.display = 'block';
      linesDiv.style.display = 'none';
      linesDiv.innerHTML = '';
    } else {
      empty.style.display = 'none';
      linesDiv.style.display = 'flex';
      linesDiv.innerHTML = parsed.map(p => `
        <div class="opp-line">
          <span class="opp-cat ${p.cls.cssClass}">${p.cls.label}</span>
          <span class="opp-text">${escHtml(p.raw.substring(0, 120))}</span>
        </div>
      `).join('');
    }
  });
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ RESULT CATALOG â€” what each specific order returns â”€â”€â”€â”€â”€â”€â”€â”€
// Per case. Each entry: { id, triggers[], resultCard HTML }
// triggers are regex patterns; ALL orders in the textarea are checked

function getCaseResultCatalog(caseId) {
  // Shared EKG + common imaging
  const commonEKG = {
    id: 'ekg',
    cat: 'ekg',
    triggers: [/\bekg\b/, /\becg\b/, /\b12.?lead\b/],
    card: (_rawLine, cId) => {
      const findings = {
        'cc-1': 'Sinus tachycardia at 118 bpm. Normal axis. No ST-elevation or depression. No ischemic changes. QTc 432 ms.',
        'cc-2': 'Sinus tachycardia at 128 bpm. New incomplete right bundle branch block (RBBB). T-wave inversions in V1â€“V4. S1Q3T3 pattern present. No ST elevation.',
        'cc-3': 'Sinus tachycardia at 126 bpm. No acute ST changes. No ischemia. QTc 418 ms.'
      };
      return resultCard('ekg', 'EKG', '12-Lead ECG', [
        { lbl: 'Rate', val: cId === 'cc-1' ? '118' : cId === 'cc-2' ? '128' : '126', unit: 'bpm', ref: '', cls: 'rv-a' },
        { lbl: 'Rhythm', val: 'Sinus tachycardia', unit: '', ref: '', cls: 'rv-ok' },
      ], findings[cId] || 'Sinus tachycardia.');
    }
  };

  const catalogs = {
    'cc-1': [
      // LABS
      { id:'lactate', cat:'lab', triggers:[/\blactate\b/, /\blactic acid\b/],
        card: () => resultCard('lab','Lab','Lactate Level',[
          {lbl:'Lactate',val:'4.5',unit:'mmol/L',ref:'0.5â€“2.0',cls:'rv-c'}
        ],'Critical value â€” indicates tissue hypoperfusion. Repeat in 2 hours to assess clearance. Target <2.0 mmol/L.') },
      { id:'cbc', cat:'lab', triggers:[/\bcbc\b/,/\bcomplete blood count\b/,/\bwbc\b/,/\bhemoglobin\b/,/\bhgb\b/],
        card: () => resultCard('lab','Lab','CBC',[
          {lbl:'WBC',    val:'19.6',unit:'K/ÂµL', ref:'4.5â€“11',cls:'rv-c'},
          {lbl:'Hgb',    val:'11.2',unit:'g/dL', ref:'12â€“16', cls:'rv-a'},
          {lbl:'Hct',    val:'34%', unit:'',      ref:'36â€“46', cls:'rv-a'},
          {lbl:'Platelets',val:'140',unit:'K/ÂµL',ref:'150â€“400',cls:'rv-a'},
        ],'Leukocytosis consistent with active infection/sepsis. Mild anemia â€” likely anemia of chronic disease.') },
      { id:'bmp', cat:'lab', triggers:[/\bbmp\b/,/\bcmp\b/,/\bbasic metabolic\b/,/\bcomprehensive metabolic\b/,/\bcreatinine\b/,/\bcreat\b/,/\bbun\b/],
        card: () => resultCard('lab','Lab','BMP / CMP',[
          {lbl:'Na',  val:'138',unit:'mEq/L',ref:'135â€“145',cls:'rv-ok'},
          {lbl:'K',   val:'4.2',unit:'mEq/L',ref:'3.5â€“5.0',cls:'rv-ok'},
          {lbl:'Cl',  val:'102',unit:'mEq/L',ref:'96â€“106', cls:'rv-ok'},
          {lbl:'COâ‚‚', val:'18', unit:'mEq/L',ref:'22â€“29',  cls:'rv-a'},
          {lbl:'BUN', val:'42', unit:'mg/dL', ref:'7â€“25',   cls:'rv-a'},
          {lbl:'Creat',val:'2.1',unit:'mg/dL',ref:'0.6â€“1.2',cls:'rv-c'},
          {lbl:'Glucose',val:'148',unit:'mg/dL',ref:'70â€“100',cls:'rv-a'},
        ],'AKI on top of CKD stage 3 (baseline Cr 1.3). Low bicarb consistent with metabolic acidosis. Hyperglycemia in T2DM.') },
      { id:'abg', cat:'lab', triggers:[/\babg\b/,/\barterial blood gas\b/,/\bph\b(?!ysical)/,/\bpao2\b/,/\bpaco2\b/],
        card: () => resultCard('lab','Lab','ABG (4L NC)',[
          {lbl:'pH',   val:'7.31',unit:'',      ref:'7.35â€“7.45',cls:'rv-c'},
          {lbl:'PaCOâ‚‚',val:'32', unit:'mm Hg', ref:'35â€“45',    cls:'rv-a'},
          {lbl:'PaOâ‚‚', val:'70', unit:'mm Hg', ref:'80â€“100',   cls:'rv-a'},
          {lbl:'HCOâ‚ƒ', val:'16', unit:'mEq/L', ref:'22â€“28',    cls:'rv-c'},
          {lbl:'SpOâ‚‚', val:'93%',unit:'',      ref:'>95%',     cls:'rv-a'},
        ],'Metabolic acidosis with partial respiratory compensation. PaOâ‚‚ 70 on 4L NC â€” hypoxemic. Assess for need to escalate oxygen support.') },
      { id:'cultures', cat:'lab', triggers:[/\bblood culture\b/,/\bbc\b(?![\w])/,/\bculture\b/],
        card: () => resultCard('lab','Lab','Blood Cultures Ã— 2',[
          {lbl:'Status',val:'Pending',unit:'',ref:'',cls:'rv-a'},
          {lbl:'Gram stain',val:'Pending',unit:'',ref:'',cls:'rv-a'},
        ],'Cultures collected and sent to microbiology. Results expected in 24â€“72 hours. Do NOT delay antibiotics waiting for culture results â€” order empiric therapy now.') },
      { id:'ua', cat:'lab', triggers:[/\bua\b(?![\w])/,/\burinalysis\b/,/\burine culture\b/],
        card: () => resultCard('lab','Lab','Urinalysis + Culture',[
          {lbl:'Color',  val:'Dark yellow',unit:'',ref:'',cls:'rv-a'},
          {lbl:'WBC',    val:'>50',unit:'/hpf',  ref:'<5',  cls:'rv-c'},
          {lbl:'Bacteria',val:'Many', unit:'',  ref:'None',cls:'rv-c'},
          {lbl:'Nitrite', val:'Pos', unit:'',   ref:'Neg', cls:'rv-c'},
        ],'Pyuria + bacteriuria â€” suggests urinary source as possible co-contributor. Send urine culture. Consider urologic evaluation.') },
      // IMAGING
      { id:'cxr', cat:'imaging', triggers:[/\bcxr\b/,/\bchest.?x.?ray\b/,/\bchest radiograph\b/,/\bportable cxr\b/,/\bportable chest\b/],
        card: () => resultCard('imaging','Imaging','Chest X-Ray (Portable)',[
          {lbl:'Findings',val:'RLL consolidation',unit:'',ref:'',cls:'rv-c'},
          {lbl:'Comparison',val:'Worsening vs admission',unit:'',ref:'',cls:'rv-c'},
          {lbl:'PTX',val:'None',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Effusion',val:'Small right',unit:'',ref:'',cls:'rv-a'},
        ],'Worsening right lower lobe consolidation compared to admission film. Consistent with pneumonia progression. No pneumothorax. Small right pleural effusion.') },
      // FLUIDS (fluid order unlocks fluid acknowledgement card)
      { id:'ivfluid', cat:'fluid', triggers:[/\blr\b(?![\w])/,/\blrs\b/,/\blactated ringer\b/,/\bnormal saline\b/,/\bns\b(?![\w])/,/\bcrystalloid\b/,/\bbolus\b/,/\biv fluid\b/,/\bplasmalyte\b/],
        card: (raw) => resultCard('fluid','Fluid','IV Fluid Order',[
          {lbl:'Status',val:'Running',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Ordered',val:extractFluidDetail(raw),unit:'',ref:'',cls:'rv-ok'},
        ],'IV fluid administration confirmed. RN has started the ordered fluid via peripheral IV. Monitor UO and repeat BP in 15 min. In septic shock, target 30 mL/kg crystalloid as initial resuscitation.') },
      // MEDS
      { id:'norepi', cat:'med', triggers:[/\bnorepinephrine\b/,/\bnorepi\b/],
        card: () => resultCard('med','Vasopressor','Norepinephrine',[
          {lbl:'Status',    val:'Infusing',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Start dose',val:'0.05',    unit:'mcg/kg/min',ref:'Titrate to MAP â‰¥65',cls:'rv-ok'},
          {lbl:'Access',    val:'Peripheral IV (antecubital)',unit:'',ref:'',cls:'rv-a'},
        ],'Norepinephrine started peripherally â€” acceptable bridge while central access is being established. Check site q1h. Titrate up by 0.02â€“0.05 mcg/kg/min q5â€“10 min. First-line for septic shock (Surviving Sepsis Campaign).') },
      { id:'vanco', cat:'med', triggers:[/\bvancomycin\b/,/\bvanco\b/],
        card: () => resultCard('med','Antibiotic','Vancomycin',[
          {lbl:'Status', val:'Ordered',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',   val:'25 mg/kg',unit:'(renal adjustment needed)',ref:'',cls:'rv-a'},
          {lbl:'Route',  val:'IV',unit:'over 60 min',ref:'',cls:'rv-ok'},
        ],'Vancomycin ordered. Dose adjustment required given CKD (Cr 2.1). Pharmacy will contact you with AUC-guided dosing. Draw vancomycin trough before 4th dose.') },
      { id:'pip', cat:'med', triggers:[/\bpiperacillin\b/,/\bzosyn\b/,/\bpip.?tazo\b/],
        card: () => resultCard('med','Antibiotic','Pip-Tazo (Zosyn)',[
          {lbl:'Status',val:'Ordered',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',  val:'3.375g', unit:'IV q8h extended infusion',ref:'',cls:'rv-ok'},
        ],'Piperacillin-tazobactam ordered. Covers GNRs including Pseudomonas. Adjust for renal function (CrCl ~30 mL/min based on current Cr).') },
      { id:'cefepime', cat:'med', triggers:[/\bcefepime\b/],
        card: () => resultCard('med','Antibiotic','Cefepime',[
          {lbl:'Status',val:'Ordered',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',  val:'1g',     unit:'IV q12h (renal-adjusted)',ref:'',cls:'rv-a'},
        ],'Cefepime ordered. Renal-adjusted dose given AKI. Broad-spectrum coverage including Pseudomonas.') },
      commonEKG,
    ],

    'cc-2': [
      { id:'abg', cat:'lab', triggers:[/\babg\b/,/\barterial blood gas\b/,/\bpao2\b/,/\bph\b(?!ys)/],
        card: () => resultCard('lab','Lab','ABG (6L NC)',[
          {lbl:'pH',    val:'7.47',unit:'',     ref:'7.35â€“7.45',cls:'rv-a'},
          {lbl:'PaCOâ‚‚', val:'30', unit:'mm Hg',ref:'35â€“45',    cls:'rv-a'},
          {lbl:'PaOâ‚‚',  val:'52', unit:'mm Hg',ref:'80â€“100',   cls:'rv-c'},
          {lbl:'HCOâ‚ƒ',  val:'22', unit:'mEq/L',ref:'22â€“28',    cls:'rv-ok'},
        ],'Acute hypoxemic respiratory failure. Respiratory alkalosis from hyperventilation. PaOâ‚‚ 52 = severe hypoxemia. Consistent with obstructive etiology given clear CXR.') },
      { id:'lactate', cat:'lab', triggers:[/\blactate\b/,/\blactic acid\b/],
        card: () => resultCard('lab','Lab','Lactate',[
          {lbl:'Lactate',val:'5.2',unit:'mmol/L',ref:'0.5â€“2.0',cls:'rv-c'}
        ],'Critically elevated lactate â€” end-organ hypoperfusion from obstructive shock. Does not indicate infection in this context. Correlate with clinical trajectory.') },
      { id:'troponin', cat:'lab', triggers:[/\btroponin\b/,/\bhstrop\b/,/\bcardiac enzymes\b/],
        card: () => resultCard('lab','Lab','Troponin I (hs)',[
          {lbl:'Troponin I',val:'53',unit:'ng/L (mild â†‘)',ref:'<16',cls:'rv-a'},
        ],'Mildly elevated troponin â€” RV strain pattern, not type 1 MI. Expect to trend down with treatment of PE. Consider repeat in 3â€“6 hours.') },
      { id:'bnp', cat:'lab', triggers:[/\bbnp\b/,/\bnt.?pro\b/,/\bnt-?proBNP\b/i],
        card: () => resultCard('lab','Lab','BNP',[
          {lbl:'BNP',val:'302',unit:'pg/mL',ref:'<100',cls:'rv-a'}
        ],'Elevated BNP indicates right ventricular wall stress from acute pressure overload consistent with massive PE.') },
      { id:'dimer', cat:'lab', triggers:[/\bd.?dimer\b/],
        card: () => resultCard('lab','Lab','D-Dimer',[
          {lbl:'D-Dimer',val:'>10,000',unit:'ng/mL FEU',ref:'<500',cls:'rv-c'}
        ],'Markedly elevated D-dimer. High probability for VTE. Given hemodynamic instability, do NOT wait for CT-PA â€” POCUS confirms RV failure. Proceed to treatment.') },
      { id:'doppler', cat:'imaging', triggers:[/\bdoppler\b/,/\ble.?doppler\b/,/\blower extremity\b/,/\bdvt\b/],
        card: () => resultCard('imaging','Imaging','LE Doppler Ultrasound',[
          {lbl:'Right femoral vein',val:'Acute DVT',unit:'',ref:'',cls:'rv-c'},
          {lbl:'Left lower ext.',  val:'No DVT',   unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Compressibility',  val:'Absent (R)',unit:'',ref:'',cls:'rv-c'},
        ],'Confirmed acute DVT right femoral vein â€” source of pulmonary embolism confirmed. Anticoagulation is indicated.') },
      { id:'cxr', cat:'imaging', triggers:[/\bcxr\b/,/\bchest.?x.?ray\b/,/\bchest radiograph\b/],
        card: () => resultCard('imaging','Imaging','Chest X-Ray (Portable)',[
          {lbl:'Lung fields',val:'Clear bilaterally',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Cardiomegaly',val:'None',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'PTX',val:'None',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Effusion',val:'None',unit:'',ref:'',cls:'rv-ok'},
        ],'Clear lung fields bilaterally â€” makes pneumonia and cardiogenic pulmonary edema less likely. Consistent with obstructive etiology (PE). "Oligemia" of right lower zone subtle but present.') },
      { id:'ctpa', cat:'imaging', triggers:[/\bctpa\b/,/\bct.?pulmonary\b/,/\bct.?angio\b/,/\bct.?chest\b/],
        card: () => resultCard('imaging','Imaging','CT Pulmonary Angiogram',[
          {lbl:'Status',val:'NOT RECOMMENDED',unit:'(patient too unstable)',ref:'',cls:'rv-c'},
        ],'âš  CT-PA requires transport and contrast load. In a hemodynamically UNSTABLE patient, POCUS demonstrating RV failure + DVT is sufficient to diagnose massive PE and initiate thrombolysis. Do not delay treatment for CT.') },
      { id:'ivfluid', cat:'fluid', triggers:[/\blr\b(?![\w])/,/\blactated ringer\b/,/\bnormal saline\b/,/\bns\b(?![\w])/,/\bcrystalloid\b/,/\bbolus\b/,/\biv fluid\b/],
        card: (raw) => {
          const vol = extractFluidVolume(raw);
          const isLarge = vol > 750;
          return resultCard('fluid', isLarge ? 'âš  Fluid Order' : 'Fluid','IV Fluid Order',[
            {lbl:'Ordered', val: extractFluidDetail(raw), unit:'',ref:'',cls: isLarge ? 'rv-c' : 'rv-a'},
            {lbl:'Warning', val: isLarge ? 'Large bolus in RV failure' : 'Small cautious bolus given', unit:'',ref:'',cls: isLarge ? 'rv-c' : 'rv-ok'},
          ], isLarge
            ? 'âš  CAUTION: Large fluid bolus in obstructive shock worsens RV dilation by increasing preload on an already-distended RV. RV-septal interaction will further impair LV filling â†’ paradoxical worsening of BP. Limit fluids to 250â€“500 mL if preload-responsive.'
            : 'Small cautious fluid bolus administered. Monitor hemodynamic response. Do not repeat unless clearly preload-responsive.');
        }
      },
      { id:'norepi', cat:'med', triggers:[/\bnorepinephrine\b/,/\bnorepi\b/],
        card: () => resultCard('med','Vasopressor','Norepinephrine',[
          {lbl:'Status',val:'Infusing',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',  val:'0.1â€“0.15',unit:'mcg/kg/min',ref:'Titrate to MAP â‰¥65',cls:'rv-ok'},
        ],'Norepinephrine maintains SVR and supports MAP without worsening tachycardia. First-line vasopressor in obstructive shock from PE. Does not fix the cause â€” definitive therapy required.') },
      { id:'heparin', cat:'med', triggers:[/\bheparin\b/,/\bunfractionated heparin\b/,/\biv heparin\b/,/\bheparin infusion\b/,/\buah\b/],
        card: () => resultCard('med','Anticoagulant','Heparin Infusion',[
          {lbl:'Status',val:'Ordered',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Bolus', val:'80 units/kg',unit:'IV (weight-based)',ref:'',cls:'rv-ok'},
          {lbl:'Infusion',val:'18 units/kg/hr',unit:'IV (per nomogram)',ref:'',cls:'rv-ok'},
          {lbl:'Note',  val:'DISCONTINUE during tPA',unit:'',ref:'',cls:'rv-a'},
        ],'Heparin started. Prevents further clot propagation. Must be DISCONTINUED during systemic thrombolysis (tPA) infusion. Resume without loading dose when aPTT <2Ã— ULN after tPA.') },
      { id:'tpa', cat:'med', triggers:[/\btpa\b/,/\balteplase\b/,/\bthrombolysis\b/,/\bthrombolytic\b/],
        card: () => resultCard('med','Thrombolytic','Alteplase (tPA)',[
          {lbl:'Dose',   val:'100 mg',  unit:'IV over 2 hours',ref:'',cls:'rv-ok'},
          {lbl:'Route',  val:'Peripheral IV',unit:'acceptable',ref:'',cls:'rv-ok'},
          {lbl:'Heparin',val:'HOLD',   unit:'during infusion',ref:'',cls:'rv-c'},
          {lbl:'Status', val:'Administering',unit:'',ref:'',cls:'rv-ok'},
        ],'Alteplase 100 mg IV over 2 hours initiated. Standard dose for massive PE. Monitor for bleeding (BP checks q15min, neuro checks). Contraindications reviewed â€” none identified. Heparin held during infusion. Resume heparin when aPTT <80 (2Ã— ULN) after infusion complete.') },
      commonEKG,
    ],

    'cc-3': [
      { id:'abg', cat:'lab', triggers:[/\babg\b/,/\barterial blood gas\b/,/\bpao2\b/,/\bph\b(?!ys)/],
        card: () => resultCard('lab','Lab','ABG (HFNC 60L FiOâ‚‚ 90%)',[
          {lbl:'pH',   val:'7.48',unit:'',     ref:'7.35â€“7.45',cls:'rv-a'},
          {lbl:'PaCOâ‚‚',val:'30', unit:'mm Hg',ref:'35â€“45',    cls:'rv-a'},
          {lbl:'PaOâ‚‚', val:'52', unit:'mm Hg',ref:'80â€“100',   cls:'rv-c'},
          {lbl:'P/F',  val:'58', unit:'mm Hg', ref:'>300 normal',cls:'rv-c'},
          {lbl:'HCOâ‚ƒ', val:'23', unit:'mEq/L',ref:'22â€“28',    cls:'rv-ok'},
        ],'Severe hypoxemia on maximal HFNC. P/F ratio 58 = Severe ARDS (Berlin criteria <100). Respiratory alkalosis from hyperventilation. HFNC failure â€” ROX index 2.5 confirms intubation needed.') },
      { id:'cxr', cat:'imaging', triggers:[/\bcxr\b/,/\bchest.?x.?ray\b/,/\bchest radiograph\b/,/\bportable cxr\b/],
        card: () => resultCard('imaging','Imaging','Chest X-Ray (Portable)',[
          {lbl:'Infiltrates',val:'Diffuse bilateral',unit:'patchy opacities',ref:'',cls:'rv-c'},
          {lbl:'Distribution',val:'Bilateral',unit:'(both lungs)',ref:'',cls:'rv-c'},
          {lbl:'PTX',        val:'None',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Cardiomegaly',val:'None',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Effusion',   val:'None',unit:'',ref:'',cls:'rv-ok'},
        ],'Bilateral diffuse patchy opacities consistent with ARDS from influenza pneumonitis. No pneumothorax. No cardiomegaly â€” POCUS confirms non-cardiogenic etiology. Berlin ARDS criteria: bilateral opacities + non-cardiogenic + P/F <100 = SEVERE ARDS.') },
      { id:'cbc', cat:'lab', triggers:[/\bcbc\b/,/\bwbc\b/,/\bhemoglobin\b/],
        card: () => resultCard('lab','Lab','CBC',[
          {lbl:'WBC',      val:'14.0',unit:'K/ÂµL',ref:'4.5â€“11',cls:'rv-a'},
          {lbl:'Hgb',      val:'13.2',unit:'g/dL',ref:'12â€“16',cls:'rv-ok'},
          {lbl:'Hct',      val:'40%', unit:'',    ref:'36â€“46',cls:'rv-ok'},
          {lbl:'Platelets',val:'185', unit:'K/ÂµL',ref:'150â€“400',cls:'rv-ok'},
        ],'Mild leukocytosis consistent with influenza A infection. Hemoglobin and platelets adequate.') },
      { id:'bmp', cat:'lab', triggers:[/\bbmp\b/,/\bcmp\b/,/\bbasic metabolic\b/,/\bcreatinine\b/,/\bcreat\b/],
        card: () => resultCard('lab','Lab','BMP',[
          {lbl:'Na',    val:'139',unit:'mEq/L',ref:'135â€“145',cls:'rv-ok'},
          {lbl:'K',     val:'3.9',unit:'mEq/L',ref:'3.5â€“5.0',cls:'rv-ok'},
          {lbl:'Creat', val:'0.9',unit:'mg/dL',ref:'0.6â€“1.1',cls:'rv-ok'},
          {lbl:'Glucose',val:'112',unit:'mg/dL',ref:'70â€“100',cls:'rv-a'},
        ],'BMP within normal limits. Renal function preserved â€” appropriate for standard dosing.') },
      { id:'rox', cat:'lab', triggers:[/\brox\b/,/\brox index\b/,/\bspo2.*fio2.*rr\b/],
        card: () => resultCard('lab','Calc','ROX Index',[
          {lbl:'SpOâ‚‚/FiOâ‚‚',val:'84%/0.90 = 93.3',unit:'',ref:'',cls:'rv-c'},
          {lbl:'Ã· RR',      val:'Ã· 38',unit:'',ref:'',cls:'rv-c'},
          {lbl:'ROX Index', val:'2.5',unit:'',ref:'>4.88 = HFNC likely succeeding',cls:'rv-c'},
        ],'ROX index 2.5 â€” well below 3.85 threshold for intubation risk. Strongly predicts HFNC failure. Proceed to intubation planning immediately.') },
      { id:'iflu', cat:'lab', triggers:[/\binfluenza\b/,/\bflu\b(?! id)/,/\brespiratory panel\b/,/\brapid flu\b/,/\brpb\b/],
        card: () => resultCard('lab','Lab','Respiratory Viral Panel',[
          {lbl:'Influenza A',val:'POSITIVE',unit:'',ref:'Negative',cls:'rv-c'},
          {lbl:'Influenza B',val:'Negative',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'COVID-19',   val:'Negative',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'RSV',        val:'Negative',unit:'',ref:'',cls:'rv-ok'},
        ],'Influenza A confirmed. Start oseltamivir 75 mg PO/NG BID Ã— 5 days (or longer in ICU patients). Consider extending duration given severity of illness.') },
      { id:'ivfluid', cat:'fluid', triggers:[/\blr\b(?![\w])/,/\blactated ringer\b/,/\bnormal saline\b/,/\bns\b(?![\w])/,/\bcrystalloid\b/,/\bbolus\b/,/\biv fluid\b/],
        card: (raw) => resultCard('fluid','Fluid','IV Fluid Order',[
          {lbl:'Ordered',val:extractFluidDetail(raw),unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Note',   val:'Conservative fluid strategy',unit:'',ref:'',cls:'rv-a'},
        ],'Fluid ordered. In ARDS, conservative fluid management after initial shock resuscitation is preferred (FACTT trial â€” +2.5 ventilator-free days with conservative strategy). Avoid fluid overload â€” worsens pulmonary edema and ventilator dependence.') },
      { id:'ketamine', cat:'med', triggers:[/\bketamine\b/],
        card: () => resultCard('med','RSI Agent','Ketamine',[
          {lbl:'Status',val:'Drawn and ready',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',  val:'1.5 mg/kg IV',  unit:'= ~108 mg push',ref:'',cls:'rv-ok'},
        ],'Ketamine is the preferred induction agent for hemodynamically tenuous patients â€” maintains SVR and HR via sympathomimetic effect. Provides bronchodilation. Excellent choice here.') },
      { id:'rsi-drugs', cat:'med', triggers:[/\bsuccinylcholine\b/,/\brocuronium\b/,/\brsi\b/,/\brapid sequence\b/,/\bparalytic\b/,/\bneuromuscular\b/],
        card: () => resultCard('med','RSI Paralytic','RSI Agent',[
          {lbl:'Succinylcholine',val:'1.5 mg/kg IV',unit:'= ~108 mg',ref:'',cls:'rv-ok'},
          {lbl:'OR Rocuronium',  val:'1.2 mg/kg IV',unit:'= ~86 mg',ref:'',cls:'rv-ok'},
          {lbl:'Sugammadex',     val:'16 mg/kg',    unit:'reversal available',ref:'',cls:'rv-ok'},
        ],'RSI paralytic agent prepared. If using rocuronium, ensure sugammadex is immediately available for reversal in case of failed airway. Succinylcholine contraindicated in hyperkalemia â€” check potassium.') },
      { id:'preoxygenate', cat:'med', triggers:[/\bpre.?oxygenate\b/,/\bnrb\b/,/\bnon.rebreather\b/,/\bhfnc flush\b/,/\bhigh flow flush\b/,/\bapneic oxygenation\b/],
        card: () => resultCard('med','Airway Prep','Pre-Oxygenation',[
          {lbl:'HFNC flush',val:'Active',unit:'60L, FiOâ‚‚ 100% Ã— 3 min',ref:'',cls:'rv-ok'},
          {lbl:'NRB overlay',val:'Applied',unit:'15L during prep',ref:'',cls:'rv-ok'},
          {lbl:'Apneic Oâ‚‚',  val:'Plan in place',unit:'maintain HFNC during laryngoscopy',ref:'',cls:'rv-ok'},
        ],'Optimal pre-oxygenation strategy in place. HFNC flush provides FiOâ‚‚ approaching 1.0. Leave cannula in during laryngoscopy for apneic oxygenation â€” this extends safe apneic time significantly in obese patients.') },
      { id:'vent', cat:'med', triggers:[/\bvent\b/,/\bventilat\b/,/\bintubate\b/,/\bintubation\b/,/\bendotracheal\b/,/\bett\b/,/\blung protect\b/,/\bardsnet\b/,/\bpeep\b/,/\btidal vol\b/],
        card: () => resultCard('med','Ventilator','Post-Intubation Vent Setup',[
          {lbl:'Mode',  val:'Volume Control (AC)',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'VT',    val:'6 mL/kg Ã— PBW',unit:'PBW = 45.5+2.3Ã—(ht"-60)',ref:'NOT actual wt',cls:'rv-ok'},
          {lbl:'PBW (5\'4")',val:'54.7 kg',unit:'â†’ VT target 328 mL',ref:'',cls:'rv-ok'},
          {lbl:'Initial PEEP',val:'10',unit:'cm Hâ‚‚O',ref:'ARDSnet table',cls:'rv-ok'},
          {lbl:'FiOâ‚‚',  val:'1.0',unit:'â†’ titrate to SpOâ‚‚ 88â€“95%',ref:'',cls:'rv-ok'},
          {lbl:'RR',    val:'20',unit:'/min initial',ref:'',cls:'rv-ok'},
          {lbl:'Pplat goal',val:'â‰¤30',unit:'cm Hâ‚‚O',ref:'Check within 30 min',cls:'rv-ok'},
        ],'ARDSnet lung-protective ventilation initiated. CRITICAL: VT must be based on PREDICTED body weight (PBW), not actual weight. With obesity, actual â‰« PBW â€” using actual weight causes volutrauma. Check plateau pressure immediately after intubation.') },
      { id:'sedation', cat:'med', triggers:[/\bpropofol\b/,/\bfentanyl\b/,/\bsedation\b/,/\banalgesia\b/,/\bmidazolam\b/,/\bversed\b/,/\banalgo.?sedation\b/,/\bpain.*sedation\b/],
        card: () => resultCard('med','Sedation/Analgesia','Post-Intubation Sedation',[
          {lbl:'Fentanyl',val:'25â€“50 mcg/hr',unit:'IV (analgesia first)',ref:'',cls:'rv-ok'},
          {lbl:'Propofol', val:'5â€“50 mcg/kg/min',unit:'IV titrate',ref:'',cls:'rv-ok'},
          {lbl:'Target RASS',val:'-1 to -2',unit:'(light sedation)',ref:'RASS 0 = awake',cls:'rv-ok'},
        ],'Analgesia-first approach (fentanyl) with propofol for comfort. Target light sedation (RASS -1 to -2) to allow daily awaking trials and spontaneous breathing trials. Avoid deep sedation â€” associated with prolonged ventilation.') },
      { id:'prone', cat:'med', triggers:[/\bprone\b/,/\bproning\b/,/\bprone.?position\b/],
        card: () => resultCard('med','Positioning','Prone Positioning',[
          {lbl:'Indication',val:'P/F <150 mm Hg',unit:'(this patient P/F ~58)',ref:'',cls:'rv-ok'},
          {lbl:'Protocol',  val:'â‰¥16 hrs/day',   unit:'(PROSEVA)',ref:'',cls:'rv-ok'},
          {lbl:'Team',      val:'6+ staff needed',unit:'for safe turn',ref:'',cls:'rv-a'},
          {lbl:'Timing',    val:'Within 36 hrs of intubation',unit:'',ref:'',cls:'rv-ok'},
        ],'Prone positioning indicated â€” P/F ratio 58 is well below the 150 mm Hg threshold. PROSEVA trial (2013): 16% absolute mortality reduction in severe ARDS with prone â‰¥16 hrs/day. Coordinate with RT and nursing for safe prone turn.') },
      { id:'tamiflu', cat:'med', triggers:[/\boseltamivir\b/,/\btamiflu\b/,/\bflu treatment\b/,/\bantiviral\b/],
        card: () => resultCard('med','Antiviral','Oseltamivir',[
          {lbl:'Status',val:'Ordered',unit:'',ref:'',cls:'rv-ok'},
          {lbl:'Dose',  val:'75 mg',unit:'PO/NG BID Ã— 5 days',ref:'',cls:'rv-ok'},
          {lbl:'Note',  val:'Consider extended course',unit:'in ICU patients',ref:'',cls:'rv-a'},
        ],'Oseltamivir initiated for confirmed influenza A. May reduce duration/severity even when started late in severe cases. Continue throughout ICU stay.') },
      commonEKG,
    ]
  };
  return catalogs[caseId] || [];
}

function resultCard(type, typeLabel, name, rows, note) {
  const typeCls = { lab:'rct-lab', imaging:'rct-imaging', ekg:'rct-ekg', fluid:'rct-fluid', med:'rct-med' }[type] || 'rct-lab';
  const tagColor = { lab:'var(--cyan)', imaging:'var(--blue)', ekg:'var(--green)', fluid:'var(--purple)', med:'var(--amber)' }[type] || 'var(--cyan)';
  return `
    <div class="result-card">
      <div class="result-card-type ${typeCls}"></div>
      <div class="result-card-inner">
        <div class="result-card-tag" style="color:${tagColor}">${typeLabel}</div>
        <div class="result-card-name">${name}</div>
        <div class="result-card-rows">
          ${rows.map(r => `
            <div class="rcr-row">
              <span class="rcr-label">${r.lbl}</span>
              <span class="rcr-val ${r.cls}">${r.val}</span>
              ${r.unit ? `<span class="rcr-unit">${r.unit}</span>` : ''}
              ${r.ref  ? `<span class="rcr-ref">${r.ref}</span>` : ''}
            </div>
          `).join('')}
        </div>
        ${note ? `<div class="result-card-note">${note}</div>` : ''}
      </div>
    </div>
  `;
}

function extractFluidDetail(orderText) {
  const m = orderText.match(/(\d+[\.,]?\d*\s*(?:ml|cc|liter|l|mg))/i);
  return m ? orderText.trim().substring(0,80) : orderText.trim().substring(0,80);
}

function extractFluidVolume(orderText) {
  const m = orderText.match(/(\d+)\s*(?:ml|cc)/i);
  if (m) return parseInt(m[1]);
  const l = orderText.match(/(\d+)\s*(?:liter|l\b)/i);
  if (l) return parseInt(l[1]) * 1000;
  return 500; // default assume 500mL
}

// â”€â”€ SUBMIT ORDERS â€” show results with staggered delay â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processOrdersAndShowResults(orderText, decisionKey, onAllDone) {
  const caseId = State.caseData.id;
  const catalog = getCaseResultCatalog(caseId);
  const lines = orderText.split('\n').filter(l => l.trim().length > 1);
  const lower = orderText.toLowerCase();

  // Find which catalog items were triggered
  const triggered = catalog.filter(item => 
    item.triggers.some(re => re.test(lower))
  );

  // Deduplicate by id
  const seen = new Set();
  const unique = triggered.filter(item => {
    if (seen.has(item.id)) return false;
    seen.add(item.id);
    return true;
  });

  // Show result feed area
  const feedWrap = $('result-feed-wrap');
  const feedCards = $('result-feed-cards');
  if (!feedWrap || !feedCards) {
    if (onAllDone) onAllDone();
    return;
  }

  feedWrap.style.display = 'block';

  if (unique.length === 0) {
    feedCards.innerHTML = `<div class="processing-row"><div class="proc-dot"></div>No specific recognizable orders found. Check your order text â€” be specific (e.g., "CBC", "Lactate", "Norepinephrine 0.05 mcg/kg/min").</div>`;
    setTimeout(() => { if (onAllDone) onAllDone(); }, 1500);
    return;
  }

  // Show "processing" first
  feedCards.innerHTML = `<div class="processing-row" id="proc-indicator"><div class="proc-dot"></div>Processing ${unique.length} order${unique.length > 1 ? 's' : ''}â€¦</div>`;

  // Stagger results at 600ms intervals
  let delay = 600;
  unique.forEach((item, idx) => {
    setTimeout(() => {
      // Remove processing indicator after first result
      if (idx === 0) {
        const pi = $('proc-indicator');
        if (pi) pi.remove();
      }
      // Find the raw line that triggered this item to pass to dynamic cards
      const rawLine = lines.find(l => item.triggers.some(re => re.test(l.toLowerCase()))) || '';
      const cardHTML = item.card(rawLine, caseId);
      const div = document.createElement('div');
      div.innerHTML = cardHTML;
      feedCards.appendChild(div.firstElementChild);
      // Scroll to show new result
      feedCards.lastElementChild && feedCards.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      // After last result, call onAllDone
      if (idx === unique.length - 1) {
        setTimeout(() => { if (onAllDone) onAllDone(); }, 800);
      }
    }, delay * (idx + 1));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPhase1_Vignette() {
  buildPhaseTrack(5, 1);
  const c = State.caseData;
  $('sim-content').innerHTML = `
    ${patientStrip()}
    <div class="sim-card">
      <div class="sim-card-head"><span class="phase-badge pb-vignette">Phase 1 Â· Case Presentation</span><span class="sim-card-title">Initial Patient Vignette</span></div>
      <div class="sim-card-body">
        <div class="vignette">${c.vignette}</div>
        <div class="btn-row"><button class="btn btn--primary" id="p1-next">Hear from Nursing â†’</button></div>
      </div>
    </div>
  `;
  $('p1-next').addEventListener('click', renderPhase2_RN);
}

function renderPhase2_RN() {
  buildPhaseTrack(5, 2);
  const c = State.caseData;
  $('sim-content').innerHTML = `
    ${patientStrip()}
    <div class="sim-card">
      <div class="sim-card-head"><span class="phase-badge pb-rn">Phase 2 Â· Nursing Report</span><span class="sim-card-title">RN Handoff</span></div>
      <div class="sim-card-body">
        <div class="rn-box">
          <div class="rn-quote">${c.rnReport}</div>
          <div class="rn-cues">${c.rnCues.map(cue => `<div class="rn-cue">${cue}</div>`).join('')}</div>
        </div>
        <div class="btn-row">
          <button class="btn btn--primary" id="p2-next">Review Objective Data â†’</button>
          <button class="btn btn--secondary" id="p2-back">â† Back</button>
        </div>
      </div>
    </div>
  `;
  $('p2-next').addEventListener('click', renderPhase3_Data);
  $('p2-back').addEventListener('click', renderPhase1_Vignette);
}

function renderPhase3_Data() {
  buildPhaseTrack(5, 3);
  const c = State.caseData;
  State.revealed = new Set();
  $('sim-content').innerHTML = `
    ${patientStrip()}
    <div class="sim-card">
      <div class="sim-card-head"><span class="phase-badge pb-action">Phase 3 Â· Objective Data</span><span class="sim-card-title">Vitals, Labs & Physical Exam</span></div>
      <div class="sim-card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
          <div>
            <div class="sec-lbl">Vital Signs</div>
            ${vitalsTable(c.vitals)}
          </div>
          <div>
            <div class="sec-lbl">Labs & Imaging</div>
            ${labGrid(c.labs, c.labNote)}
          </div>
        </div>
        <div>
          <div class="sec-lbl">Physical Examination â€” Tap a system to examine</div>
          ${examGrid(c.examSystems)}
        </div>
        <div class="mt-20">
          <div class="sec-lbl">POCUS</div>
          ${pocusBlock(c.pocus)}
        </div>
        <div class="btn-row">
          <button class="btn btn--primary" id="p3-next">Proceed to Decision â†’</button>
          <button class="btn btn--secondary" id="p3-back">â† Back</button>
        </div>
      </div>
    </div>
  `;
  bindExamButtons();
  $('p3-next').addEventListener('click', () => renderPhase4_Decision('decision1'));
  $('p3-back').addEventListener('click', renderPhase2_RN);
}

function renderPhase4_Decision(decisionKey) {
  buildPhaseTrack(5, 4);
  const c = State.caseData;
  const dec = c[decisionKey];
  if (!dec) { renderPhase3_Data(); return; }
  State.currentDecision = decisionKey;

  $('sim-content').innerHTML = `
    ${patientStrip()}
    ${dec.conditionAlert ? `<div class="sim-card"><div class="sim-card-head"><span class="phase-badge pb-alert">Condition Update</span><span class="sim-card-title">Patient Status Change</span></div><div class="sim-card-body">${conditionAlertBlock(dec)}${dec.vitals ? '<div class="mt-16"><div class="sec-lbl">Updated Vitals</div>' + vitalsTable(dec.vitals) + '</div>' : ''}</div></div>` : ''}
    <div class="sim-card">
      <div class="sim-card-head"><span class="phase-badge pb-branch">Phase 4 Â· Clinical Decision</span><span class="sim-card-title">${dec.title}</span></div>
      <div class="sim-card-body">
        <div class="vignette" style="margin-bottom:20px;">${dec.prompt}</div>
        ${ordersSection(decisionKey)}
      </div>
    </div>
  `;
  bindOrderPreview();
  bindDecisionSubmit(decisionKey);
}

function bindDecisionSubmit(decisionKey) {
  const btn = $('submit-orders');
  if (!btn) return;
  btn.addEventListener('click', () => {
    const ta = $('orders-ta');
    const text = ta ? ta.value : '';
    if (!text.trim()) {
      showRNMsg('No Orders Entered',
        'Please enter at least one order before submitting.\n\nExamples:\nâ€¢ "Lactate, CBC, BMP"\nâ€¢ "Blood cultures x2"\nâ€¢ "30 mL/kg LR bolus IV"\nâ€¢ "Norepinephrine 0.05 mcg/kg/min IV"',
        'SYSTEM');
      return;
    }
    // Lock UI while processing
    if (ta) ta.disabled = true;
    btn.disabled = true;
    btn.textContent = 'Processing ordersâ€¦';
    // Show order results, then fire branch logic
    processOrdersAndShowResults(text, decisionKey, () => {
      evaluateBranch(decisionKey, text);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BRANCH EVALUATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function evaluateBranch(decisionKey, orderText) {
  const c = State.caseData;
  const dec = c[decisionKey];
  const lower = orderText.toLowerCase();

  let matched = dec.branches.find(b => {
    if (b.triggers.length === 0 && b.requires === 0) return false; // skip default for now
    if (b.excludes && b.excludes.length > 0) {
      if (b.excludes.some(ex => lower.includes(ex))) return false;
    }
    const hits = b.triggers.filter(t => lower.includes(t)).length;
    // count unique categories hit (simple: just count total matches â‰¥ requires)
    return hits >= b.requires;
  });

  if (!matched) {
    matched = dec.branches.find(b => b.requires === 0); // fallback to default
  }

  State.decisions.push({ decKey: decisionKey, branchId: matched.id, type: matched.type });
  renderBranchResult(decisionKey, matched);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BRANCH RESULT RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderBranchResult(decisionKey, branch) {
  buildPhaseTrack(5, 5);
  const c = State.caseData;

  // Show outcome block appended to sim-content
  const content = $('sim-content');

  // Remove old outcome if exists
  const old = document.getElementById('branch-result-block');
  if (old) old.remove();

  const block = CE('div');
  block.id = 'branch-result-block';
  block.innerHTML = `
    <div class="sim-card">
      <div class="sim-card-head"><span class="phase-badge pb-branch">Patient Response</span><span class="sim-card-title">${branch.headline}</span></div>
      <div class="sim-card-body">
        <div class="branch-outcome ${branch.type}">
          <div class="bo-label">${branch.label}</div>
          <div class="bo-text">${branch.narrative}</div>
        </div>
        ${renderNextActions(decisionKey, branch)}
      </div>
    </div>
  `;
  content.appendChild(block);
  block.scrollIntoView({ behavior: 'smooth', block: 'start' });
  bindNextActions(decisionKey, branch);
}

function renderNextActions(decisionKey, branch) {
  // Determine what happens next
  if (branch.endMsg !== undefined && branch.endMsg !== null) {
    // Terminal branch
    const iconClass = branch.endState === 'good' ? 'success' : 'concern';
    const iconChar = branch.endState === 'good' ? 'âœ“' : '!';
    const summaryItems = (branch.decisions || []).map(d => `<div class="summary-item">${d}</div>`).join('');
    return `
      <div class="mt-20">
        <div class="end-box">
          <div class="end-icon ${iconClass}">${iconChar}</div>
          <div class="end-title" style="color:var(--${branch.endState === 'good' ? 'green' : 'amber'})">${branch.endState === 'good' ? 'Case Complete' : 'Case Concluded'}</div>
          <div class="end-text">${branch.endMsg}</div>
          ${summaryItems ? `<div class="summary-box"><div class="summary-lbl">Your Decision Pathway</div>${summaryItems}</div>` : ''}
          <div class="btn-row" style="justify-content:center;">
            <button class="btn btn--primary" id="btn-restart">Restart Case</button>
            <button class="btn btn--secondary" id="btn-cases">Select Another Case</button>
            <button class="btn btn--secondary" id="btn-home">Return Home</button>
          </div>
        </div>
      </div>
    `;
  }

  // Has a next decision
  const nextKey = branch.nextDecision;
  if (nextKey) {
    return `
      <div class="btn-row mt-20">
        <button class="btn btn--primary" id="btn-next-decision" data-next="${nextKey}">Continue to Next Decision â†’</button>
      </div>
    `;
  }

  // Fallback
  return `
    <div class="btn-row mt-20">
      <button class="btn btn--secondary" id="btn-cases">Select Another Case</button>
    </div>
  `;
}

function bindNextActions(decisionKey, branch) {
  const nextBtn = $('btn-next-decision');
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      const nextKey = nextBtn.dataset.next;
      renderPhase4_Decision(nextKey);
    });
  }
  const restartBtn = $('btn-restart');
  if (restartBtn) restartBtn.addEventListener('click', () => { State.revealed = new Set(); State.decisions = []; renderPhase1_Vignette(); });
  const casesBtn = $('btn-cases');
  if (casesBtn) casesBtn.addEventListener('click', () => { State.reset(); showScreen('screen-cases'); });
  const homeBtn = $('btn-home');
  if (homeBtn) homeBtn.addEventListener('click', () => { State.reset(); showScreen('screen-home'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RN MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showRNMsg(title, msg, tag = 'RN MESSAGE') {
  $('rn-tag').textContent = tag;
  $('rn-title').textContent = title;
  $('rn-body').innerHTML = `<div class="rn-from">Notification</div><div>${msg}</div>`;
  openModal('modal-rn');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init() {
  // Home â†’ cases
  document.querySelectorAll('.module-card--active').forEach(card => {
    const go = () => { renderCaseList(); showScreen('screen-cases'); };
    card.addEventListener('click', go);
    card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); go(); }});
  });

  // Locked module
  document.querySelectorAll('.module-card--locked').forEach(card => {
    card.addEventListener('click', () => {
      showRNMsg('Module Locked', 'The Sepsis Simulation is currently in development. Check back soon.', 'SYSTEM');
    });
  });

  // Nav buttons
  $('back-to-home').addEventListener('click', () => { State.reset(); showScreen('screen-home'); });
  $('back-to-cases').addEventListener('click', () => { State.reset(); showScreen('screen-cases'); });

  // Modal controls
  $('close-rn').addEventListener('click', () => closeModal('modal-rn'));
  $('rn-ok').addEventListener('click', () => closeModal('modal-rn'));
  $('close-branch').addEventListener('click', () => closeModal('modal-branch'));
  $('branch-ok').addEventListener('click', () => closeModal('modal-branch'));

  document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) closeAllModals(); });
  });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });
}

document.addEventListener('DOMContentLoaded', init);
